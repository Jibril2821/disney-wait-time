<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="TDR.jpg">
    <title>å¾…ã¡æ™‚é–“å±¥æ­´ãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        h1 .title-text {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .park-name {
            color: #a0a0a0;
            margin-top: 10px;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            align-items: center;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
        }

        select {
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.95rem;
            cursor: pointer;
            outline: none;
            min-width: 200px;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        /* æœŸé–“é¸æŠã‚¿ãƒ– */
        .period-tabs {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.05);
            padding: 5px;
            border-radius: 30px;
        }

        .period-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: transparent;
            color: #a0a0a0;
        }

        .period-tab:hover {
            color: #fff;
        }

        .period-tab.active {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #fff;
        }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .data-info {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .data-info h3 {
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .data-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .data-info-item {
            text-align: center;
        }

        .data-info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f9ca24;
        }

        .data-info-label {
            font-size: 0.85rem;
            color: #a0a0a0;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #a0a0a0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #a0a0a0;
        }

        .no-data h2 {
            margin-bottom: 20px;
            color: #fff;
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255,107,107,0.1);
            border-radius: 20px;
            color: #ff6b6b;
        }

        /* å…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ */
        .rides-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .ride-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ride-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.08);
            border-color: rgba(78,205,196,0.5);
        }

        .ride-card.closed {
            opacity: 0.5;
        }

        .ride-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .ride-card-name {
            font-size: 0.95rem;
            font-weight: 600;
            flex: 1;
            margin-right: 10px;
        }

        .ride-card-fav-btn {
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
            margin-left: 6px;
            transition: color 0.2s ease, transform 0.1s ease;
        }

        .ride-card-fav-btn:hover {
            color: #ffd86b;
            transform: scale(1.1);
        }

        .ride-card-fav-btn.active {
            color: #ffd86b;
        }

        .ride-card-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .ride-card-status.open {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .ride-card-status.closed {
            background: rgba(255,255,255,0.2);
            color: #a0a0a0;
        }

        .ride-card-wait {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .ride-card-wait-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .ride-card-wait-unit {
            font-size: 0.9rem;
            color: #a0a0a0;
        }

        .ride-card-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .ride-card-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ride-card-stat-label {
            font-size: 1rem;
            color: #a0a0a0;
        }

        .ride-card-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .ride-card-stat-value .unit {
            font-size: 1rem;
            font-weight: 400;
            color: #a0a0a0;
            margin-left: 2px;
        }

        /* .ride-card-stat-value.wait-* ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ park-data.js ã‹ã‚‰å‹•çš„ã«æ³¨å…¥ã•ã‚Œã¾ã™ */

        .ride-card-no-data {
            color: #a0a0a0;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
        }

        /* ã‚¨ãƒªã‚¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .area-section {
            margin-bottom: 40px;
        }

        .area-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px 25px;
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
        }

        .area-header-icon {
            font-size: 2rem;
        }

        .area-header-info {
            flex: 1;
        }

        .area-header-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .area-header-stats {
            font-size: 0.85rem;
            color: #a0a0a0;
        }

        /* TDL ã‚¨ãƒªã‚¢ã‚«ãƒ©ãƒ¼ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰ */
        .area-worldbazaar .area-header { border-left: 4px solid #e74c3c; }
        .area-adventureland .area-header { border-left: 4px solid #27ae60; }
        .area-westernland .area-header { border-left: 4px solid #d35400; }
        .area-crittercountry .area-header { border-left: 4px solid #8e44ad; }
        .area-fantasyland .area-header { border-left: 4px solid #e91e63; }
        .area-toontown .area-header { border-left: 4px solid #f39c12; }
        .area-tomorrowland .area-header { border-left: 4px solid #3498db; }

        /* TDS ã‚¨ãƒªã‚¢ã‚«ãƒ©ãƒ¼ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰ */
        .area-mediterranean .area-header { border-left: 4px solid #8e44ad; }
        .area-americanwaterfront .area-header { border-left: 4px solid #e74c3c; }
        .area-portdiscovery .area-header { border-left: 4px solid #3498db; }
        .area-lostriverdelta .area-header { border-left: 4px solid #27ae60; }
        .area-arabiancoast .area-header { border-left: 4px solid #f39c12; }
        .area-mermaidlagoon .area-header { border-left: 4px solid #e91e63; }
        .area-mysteriousisland .area-header { border-left: 4px solid #1abc9c; }
        .area-fantasysprings .area-header { border-left: 4px solid #9b59b6; }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: #4ecdc4;
        }

        tr:hover {
            background: rgba(255,255,255,0.03);
        }

        /* .wait-* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯ park-data.js ã‹ã‚‰å‹•çš„ã«æ³¨å…¥ã•ã‚Œã¾ã™ */

        .back-to-list-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-to-list-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        /* ã‚¨ãƒªã‚¢ã‚¿ãƒ– */
        .area-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .area-tab {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.08);
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-align: center;
        }

        .area-tab:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .area-tab.active {
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .area-tab .area-icon {
            font-size: 1rem;
        }

        .area-tab .area-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* TDL ã‚¨ãƒªã‚¢ã‚«ãƒ©ãƒ¼ */
        .area-tab.area-worldbazaar.active { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .area-tab.area-adventureland.active { background: linear-gradient(135deg, #27ae60, #1e8449); }
        .area-tab.area-westernland.active { background: linear-gradient(135deg, #d35400, #a04000); }
        .area-tab.area-crittercountry.active { background: linear-gradient(135deg, #8e44ad, #6c3483); }
        .area-tab.area-fantasyland.active { background: linear-gradient(135deg, #e91e63, #c2185b); }
        .area-tab.area-toontown.active { background: linear-gradient(135deg, #f39c12, #d68910); }
        .area-tab.area-tomorrowland.active { background: linear-gradient(135deg, #3498db, #2874a6); }

        /* TDS ã‚¨ãƒªã‚¢ã‚«ãƒ©ãƒ¼ */
        .area-tab.area-mediterranean.active { background: linear-gradient(135deg, #8e44ad, #6c3483); }
        .area-tab.area-americanwaterfront.active { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .area-tab.area-portdiscovery.active { background: linear-gradient(135deg, #3498db, #2874a6); }
        .area-tab.area-lostriverdelta.active { background: linear-gradient(135deg, #27ae60, #1e8449); }
        .area-tab.area-arabiancoast.active { background: linear-gradient(135deg, #f39c12, #d68910); }
        .area-tab.area-mermaidlagoon.active { background: linear-gradient(135deg, #e91e63, #c2185b); }
        .area-tab.area-mysteriousisland.active { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .area-tab.area-fantasysprings.active { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .overview-chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .overview-chart-container canvas {
            max-height: 400px;
        }

        .visit-summary {
            margin-bottom: 16px;
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(0,0,0,0.25);
            font-size: 0.85rem;
            color: #ddd;
        }

        .visit-summary-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #f9ca24;
        }

        .visit-summary-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
        }

        .visit-summary-item {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .visit-summary-rank {
            font-weight: 600;
            color: #ffd86b;
        }

        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ã‚°ãƒ©ãƒ•ï¼‰ */
        .compare-toolbar {
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            font-size: 0.8rem;
        }

        .compare-toolbar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .compare-toolbar-title {
            font-weight: 600;
            color: #f9ca24;
        }

        .compare-select {
            padding: 6px 10px;
            border-radius: 10px;
            border: none;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.8rem;
            min-width: 200px;
        }

        .compare-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .compare-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.1);
            font-size: 0.75rem;
        }

        .compare-chip button {
            border: none;
            background: transparent;
            color: #ffd86b;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
        }

        /* æ··é›‘ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— */
        .heatmap-container {
            margin-bottom: 24px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 16px 18px;
        }

        .heatmap-title {
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .heatmap-note {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-bottom: 8px;
        }

        .heatmap-table-wrapper {
            overflow-x: auto;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 4px 6px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            border-right: 1px solid rgba(255,255,255,0.04);
            text-align: center;
            white-space: nowrap;
        }

        .heatmap-table th:first-child,
        .heatmap-table td:first-child {
            position: sticky;
            left: 0;
            background: rgba(15, 23, 42, 0.95);
            z-index: 1;
            text-align: left;
        }

        .heatmap-header {
            background: rgba(255,255,255,0.04);
            font-size: 0.7rem;
            color: #cccccc;
        }

        .heatmap-ride-name {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .heatmap-cell {
            min-width: 30px;
            font-size: 0.7rem;
        }

        .heat-none {
            background: rgba(0,0,0,0.1);
            color: #666;
        }

        /* .heatmap-cell.wait-* ã‚¹ã‚¿ã‚¤ãƒ«ã¯ park-data.js ã‹ã‚‰å‹•çš„ã«æ³¨å…¥ã•ã‚Œã¾ã™ */

        /* æ›œæ—¥Ã—æ™‚é–“å¸¯ãƒãƒˆãƒªã‚¯ã‚¹ */
        .matrix-best-cell {
            outline: 2px solid #f9ca24;
            outline-offset: -2px;
            position: relative;
        }

        .matrix-day-label {
            min-width: 30px;
            font-weight: 600;
        }

        /* æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰ */
        .calendar-container {
            margin-bottom: 24px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 16px 18px;
        }

        .calendar-title {
            font-size: 1rem;
            margin-bottom: 6px;
        }

        .calendar-note {
            font-size: 0.8rem;
            color: #a0a0a0;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 0.8rem;
        }

        .calendar-weekday {
            text-align: center;
            color: #a0a0a0;
            padding: 4px 0;
        }

        .calendar-day {
            min-height: 46px;
            border-radius: 10px;
            padding: 4px 6px;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .calendar-day:hover:not(.disabled) {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            opacity: 0.9;
        }

        .calendar-day.disabled {
            cursor: default;
            opacity: 0.3;
            background: rgba(15,23,42,0.6);
        }

        .calendar-day.disabled:hover {
            transform: none;
            box-shadow: none;
            background: rgba(15,23,42,0.6);
        }

        .calendar-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .calendar-day-date {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .calendar-day-weekday {
            font-size: 0.7rem;
            color: #a0a0a0;
        }

        .calendar-day-value {
            font-size: 0.8rem;
        }

        /* .calendar-day.wait-* ã‚¹ã‚¿ã‚¤ãƒ«ã¯ park-data.js ã‹ã‚‰å‹•çš„ã«æ³¨å…¥ã•ã‚Œã¾ã™ */

        /* å¹´ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .year-calendars-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .year-calendar-month {
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            padding: 12px;
        }

        .year-calendar-month-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            color: #a0a0a0;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #a0a0a0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .legend-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .legend-item.hidden {
            opacity: 0.4;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .favorites-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 8px;
        }

        .fav-toggle-btn {
            padding: 8px 14px;
            border-radius: 16px;
            border: none;
            background: rgba(255,255,255,0.06);
            color: #ffdd88;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }

        .fav-toggle-btn:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .fav-toggle-btn.active {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: #4b2c20;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        /* å‰å›ã®æ¥åœ’æ—¥ã¨æ¯”è¼ƒ */
        .compare-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .compare-section-title {
            font-size: 1.25rem;
            margin-bottom: 16px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compare-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .compare-controls label {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        .compare-controls select {
            padding: 10px 16px;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 180px;
        }

        .compare-controls select option {
            background: #1a1a2e;
            color: #fff;
        }

        .compare-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .compare-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78,205,196,0.4);
        }

        .compare-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .compare-note {
            font-size: 0.8rem;
            color: #a0a0a0;
            margin: -8px 0 12px 0;
        }

        .compare-summary {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 1.05rem;
            text-align: center;
        }

        .compare-summary.less {
            background: rgba(78,205,196,0.15);
            border: 1px solid rgba(78,205,196,0.4);
            color: #4ecdc4;
        }

        .compare-summary.more {
            background: rgba(255,107,107,0.15);
            border: 1px solid rgba(255,107,107,0.4);
            color: #ff6b6b;
        }

        .compare-summary.same {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: #a0a0a0;
        }

        .compare-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            background: rgba(0,0,0,0.2);
        }

        .compare-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .compare-table th,
        .compare-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .compare-table th {
            background: rgba(255,255,255,0.06);
            color: #4ecdc4;
            font-weight: 600;
        }

        .compare-table td.compare-diff-less {
            color: #4ecdc4;
            font-weight: 600;
        }

        .compare-table td.compare-diff-more {
            color: #ff6b6b;
            font-weight: 600;
        }

        .compare-table td.compare-diff-same {
            color: #a0a0a0;
        }

        .compare-no-data {
            text-align: center;
            color: #a0a0a0;
            padding: 20px;
            font-size: 0.95rem;
        }

        /* ã‚°ãƒ©ãƒ•ã®ç‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .point-popup-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            z-index: 9999;
        }

        .point-popup {
            position: absolute;
            min-width: 260px;
            background: #1e2749;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 14px;
            color: #fff;
            font-size: 0.85rem;
        }

        .point-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .point-popup-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .point-popup-close {
            background: transparent;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 1rem;
        }

        .point-popup-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-x: hidden;
            margin-top: 4px;
        }

        .point-popup-item {
            width: 100%;
            text-align: left;
            border: none;
            border-radius: 8px;
            padding: 6px 14px; /* å·¦å³ã«å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            background: rgba(255,255,255,0.04);
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .point-popup-item:hover {
            background: rgba(78,205,196,0.25);
        }

        .point-popup-item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
        }

        .point-popup-item-name {
            font-weight: 600;
            white-space: nowrap;
        }

        .point-popup-item-meta {
            font-size: 0.75rem;
            color: #a0a0a0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .back-btn {
                position: static;
                margin-bottom: 20px;
            }

            .controls {
                flex-direction: column;
            }

            select, .btn {
                width: 100%;
            }

            .area-tabs {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .area-tab {
                padding: 10px 12px;
                font-size: 0.75rem;
            }

            .rides-grid {
                grid-template-columns: 1fr;
            }

            .area-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
    <script src="park-data.js"></script>
    <script src="supabase-config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-btn">â† å¾…ã¡æ™‚é–“ã«æˆ»ã‚‹</a>
            <h1>ğŸ“Š <span class="title-text">å¾…ã¡æ™‚é–“å±¥æ­´</span></h1>
            <p class="park-name" id="parkName">èª­ã¿è¾¼ã¿ä¸­...</p>
        </header>

        <div class="controls">
            <div class="period-tabs">
                <button class="period-tab active" data-period="day">æ—¥</button>
                <button class="period-tab" data-period="week">é€±</button>
                <button class="period-tab" data-period="month">æœˆ</button>
                <button class="period-tab" data-period="year">å¹´</button>
            </div>
            <div class="file-input-wrapper" id="fileInputWrapper" style="display: none;">
                <button class="btn">ğŸ“ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                <input type="file" id="fileInput" accept=".json" multiple>
            </div>
            <select id="dateSelect">
                <option value="">æ—¥ä»˜ã‚’é¸æŠ...</option>
            </select>
            <select id="rideSelect" disabled>
                <option value="all">ã™ã¹ã¦ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</option>
            </select>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‘ãƒ¼ã‚¯ãƒ»ã‚¨ãƒªã‚¢ãƒ»ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ã¯ park-data.js ã‹ã‚‰èª­ã¿è¾¼ã¿
        const USE_SUPABASE = typeof window !== 'undefined' && window.SUPABASE_URL && window.SUPABASE_ANON_KEY;

        let currentPark = null;
        let loadedData = null;
        let availableDates = [];
        let chart = null;
        let overviewChart = null;
        let selectedAreas = []; // ç©ºé…åˆ— = ã™ã¹ã¦é¸æŠ
        let currentPeriod = 'day'; // day, week, month, year
        let initialRideHandled = false; // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®rideå‡¦ç†æ¸ˆã¿ãƒ•ãƒ©ã‚°
        let favoriteRideIds = new Set(); // ãŠæ°—ã«å…¥ã‚Šã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³IDç¾¤ï¼ˆæ–‡å­—åˆ—ï¼‰
        let showFavoritesOnly = false; // true ã®ã¨ããŠæ°—ã«å…¥ã‚Šã®ã¿è¡¨ç¤º
        let compareRideIds = new Set(); // è©³ç´°ã‚°ãƒ©ãƒ•ã®æ¯”è¼ƒå¯¾è±¡IDç¾¤ï¼ˆæ–‡å­—åˆ—ï¼‰
        let currentDetailRideId = null; // ç¾åœ¨ã®è©³ç´°è¡¨ç¤ºä¸­ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ID

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‘ãƒ¼ã‚¯ã¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const parkParam = urlParams.get('park');
        const rideParam = urlParams.get('ride');

        if (parkParam && PARKS[parkParam]) {
            currentPark = parkParam;
        } else {
            currentPark = 'land';
        }

        function getRideName(rideId, originalName) {
            // park-data.js ã®çµ±ä¸€æ§‹é€  { area, name } ã‹ã‚‰åå‰ã‚’å–å¾—
            const rideInfo = currentPark === 'land' ? TDL_RIDE_INFO[rideId] : TDS_RIDE_INFO[rideId];
            return rideInfo?.name || originalName;
        }

        function getRideArea(rideId) {
            const rideInfo = currentPark === 'land' ? TDL_RIDE_INFO[rideId] : TDS_RIDE_INFO[rideId];
            return rideInfo?.area || 'other';
        }

        function getAreas() {
            return currentPark === 'land' ? TDL_AREAS : TDS_AREAS;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const parkInfo = PARKS[currentPark];
            document.getElementById('parkName').textContent = `${parkInfo.icon} ${parkInfo.name}`;
            document.title = `${parkInfo.name} å¾…ã¡æ™‚é–“å±¥æ­´`;
            
            document.querySelector('.back-btn').href = `index.html?park=${currentPark}`;

            // ãŠæ°—ã«å…¥ã‚Šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
            loadFavoriteRides();
            
            if (USE_SUPABASE) {
                await loadAvailableDatesFromSupabase();
            } else {
                showLocalFileUI();
            }
        }

        function showLocalFileUI() {
            document.getElementById('fileInputWrapper').style.display = 'block';
            document.getElementById('dateSelect').style.display = 'none';
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="no-data">
                    <h2>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</h2>
                    <p>Supabase ã‚’ä½¿ã†å ´åˆã¯ supabase-config.js ã« URL ã¨ anon ã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    <p style="margin-top: 15px;">æœªè¨­å®šã®å ´åˆã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã‚ã¾ã™ã€‚</p>
                </div>
            `;
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;

            const allRecords = [];
            let parkName = '';

            for (const file of files) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    parkName = data.park || parkName;
                    
                    for (const record of data.records) {
                        allRecords.push({
                            date: data.date,
                            time: record.time,
                            timestamp: record.timestamp,
                            rides: record.rides
                        });
                    }
                } catch (e) {
                    console.error(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${file.name}`, e);
                }
            }

            if (allRecords.length === 0) {
                content.innerHTML = `
                    <div class="error">
                        <h3>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                        <p>æœ‰åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            allRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            loadedData = {
                park: parkName,
                date: allRecords[0].date,
                records: allRecords
            };

            populateRideSelect();
            showAllRides();
        }

        function getSupabaseHeaders() {
            return {
                'apikey': window.SUPABASE_ANON_KEY || '',
                'Authorization': 'Bearer ' + (window.SUPABASE_ANON_KEY || ''),
                'Accept': 'application/json'
            };
        }

        async function loadAvailableDatesFromSupabase() {
            const parkInfo = PARKS[currentPark];
            const content = document.getElementById('content');
            const baseUrl = (window.SUPABASE_URL || '').replace(/\/$/, '');
            try {
                const url = `${baseUrl}/rest/v1/wait_time_snapshots?park_id=eq.${encodeURIComponent(currentPark)}&select=date&order=timestamp.desc&limit=5000`;
                const response = await fetch(url, { method: 'GET', headers: getSupabaseHeaders(), cache: 'no-store' });
                if (!response.ok) throw new Error('Supabase ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                const rows = await response.json();
                const dateSet = new Set();
                (rows || []).forEach(r => { if (r.date) dateSet.add(r.date); });
                availableDates = [...dateSet].sort().reverse();

                if (availableDates.length === 0) {
                    content.innerHTML = `
                        <div class="no-data">
                            <h2>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                            <p>ã¾ã å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒ Supabase ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                        </div>
                    `;
                    return;
                }
                document.getElementById('fileInputWrapper').style.display = 'none';
                document.getElementById('dateSelect').style.display = '';
                await updateDateSelectOptions();
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `
                    <div class="error">
                        <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function fetchSupabaseDataForDate(parkId, dateStr) {
            if (!dateStr || !parkId) return null;
            const baseUrl = (window.SUPABASE_URL || '').replace(/\/$/, '');
            const url = `${baseUrl}/rest/v1/wait_time_snapshots?park_id=eq.${encodeURIComponent(parkId)}&date=eq.${encodeURIComponent(dateStr)}&order=time.asc`;
            try {
                const response = await fetch(url, { method: 'GET', headers: getSupabaseHeaders(), cache: 'no-store' });
                if (!response.ok) return null;
                const rows = await response.json();
                if (!Array.isArray(rows) || rows.length === 0) return null;
                const parkInfo = PARKS[parkId];
                return {
                    date: dateStr,
                    records: rows.map(r => ({
                        date: r.date,
                        time: r.time,
                        timestamp: r.timestamp,
                        rides: r.rides || []
                    }))
                };
            } catch (e) {
                return null;
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { month: 'long', day: 'numeric', weekday: 'short' };
            return date.toLocaleDateString('ja-JP', options);
        }

        function populateRideSelect() {
            const select = document.getElementById('rideSelect');
            select.innerHTML = '<option value="all">ã™ã¹ã¦ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</option>';
            
            if (!loadedData || loadedData.records.length === 0) return;

            const ridesMap = new Map();
            for (const record of loadedData.records) {
                for (const ride of record.rides) {
                    if (!ridesMap.has(ride.id)) {
                        ridesMap.set(ride.id, getRideName(ride.id, ride.name));
                    }
                }
            }

            const sortedRides = [...ridesMap.entries()].sort((a, b) => a[1].localeCompare(b[1], 'ja'));
            
            for (const [id, name] of sortedRides) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                select.appendChild(option);
            }

            select.disabled = false;
            select.value = 'all';
        }

        function showAllRides() {
            const content = document.getElementById('content');
            
            if (!loadedData || loadedData.records.length === 0) return;

            const latestRecord = loadedData.records[loadedData.records.length - 1];
            const recordCount = loadedData.records.length;
            const firstTime = loadedData.records[0]?.time || '-';
            const lastTime = latestRecord?.time || '-';
            const areas = getAreas();

            // å„ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®çµ±è¨ˆã‚’è¨ˆç®—
            const rideStats = new Map();
            
            for (const record of loadedData.records) {
                for (const ride of record.rides) {
                    if (!rideStats.has(ride.id)) {
                        rideStats.set(ride.id, {
                            id: ride.id,
                            name: getRideName(ride.id, ride.name),
                            area: getRideArea(ride.id),
                            waits: [],
                            timeData: [],
                            lastOpen: false,
                            lastWait: 0
                        });
                    }
                    const stat = rideStats.get(ride.id);
                    if (ride.is_open && ride.wait_time > 0) {
                        stat.waits.push(ride.wait_time);
                    }
                    stat.timeData.push({
                        date: record.date,
                        time: record.time,
                        wait: ride.is_open ? ride.wait_time : null
                    });
                    stat.lastOpen = ride.is_open;
                    stat.lastWait = ride.wait_time;
                }
            }

            // ã‚«ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            let rideCards = [...rideStats.values()].map(stat => {
                const avgWait = stat.waits.length > 0 
                    ? Math.round(stat.waits.reduce((a, b) => a + b, 0) / stat.waits.length) 
                    : 0;
                const maxWait = stat.waits.length > 0 ? Math.max(...stat.waits) : 0;
                const minWait = stat.waits.length > 0 ? Math.min(...stat.waits) : 0;
                
                return {
                    ...stat,
                    avgWait,
                    maxWait,
                    minWait
                };
            }).sort((a, b) => a.name.localeCompare(b.name, 'ja'));

            // ã‚¨ãƒªã‚¢ã”ã¨ã®ã‚«ã‚¦ãƒ³ãƒˆ
            const areaCounts = {};
            Object.keys(areas).forEach(key => {
                areaCounts[key] = rideCards.filter(r => r.area === key).length;
            });

            // ã‚¨ãƒªã‚¢ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç©ºé…åˆ— = ã™ã¹ã¦é¸æŠï¼‰
            const isAllSelected = selectedAreas.length === 0;
            let filteredCards = isAllSelected 
                ? rideCards 
                : rideCards.filter(r => selectedAreas.includes(r.area));

            // ãŠæ°—ã«å…¥ã‚Šãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼ˆæœ‰åŠ¹ãªå ´åˆï¼‰
            if (showFavoritesOnly && favoriteRideIds.size > 0) {
                filteredCards = filteredCards.filter(r => favoriteRideIds.has(String(r.id)));
            }

            const openCount = filteredCards.filter(r => r.lastOpen).length;

            content.innerHTML = `
                <div class="favorites-toolbar">
                    <button class="fav-toggle-btn ${showFavoritesOnly ? 'active' : ''}" id="favToggleBtn">
                        â˜… ãŠæ°—ã«å…¥ã‚Šã ã‘è¡¨ç¤º
                    </button>
                </div>
                <div class="area-tabs" id="areaTabs">
                    <button class="area-tab ${isAllSelected ? 'active' : ''}" data-area="all">
                        <span class="area-icon">ğŸ¡</span>
                        <span>ã™ã¹ã¦</span>
                        <span class="area-count">${showFavoritesOnly ? filteredCards.length : rideCards.length}</span>
                    </button>
                    ${Object.entries(areas).map(([key, area]) => 
                        areaCounts[key] > 0 ? `
                            <button class="area-tab area-${key} ${selectedAreas.includes(key) ? 'active' : ''}" data-area="${key}">
                                <span class="area-icon">${area.icon}</span>
                                <span>${area.name}</span>
                                <span class="area-count">${areaCounts[key]}</span>
                            </button>
                        ` : ''
                    ).join('')}
                </div>

                <div class="overview-chart-container">
                    <h2 class="chart-title">ğŸ“ˆ å¾…ã¡æ™‚é–“æ¨ç§»ã‚°ãƒ©ãƒ•${!isAllSelected ? ` - ${selectedAreas.map(a => areas[a]?.icon).join(' ')}` : ''}</h2>
                    <div class="visit-summary" id="visitSummary"></div>
                    <canvas id="overviewChart"></canvas>
                    <div class="chart-legend" id="chartLegend"></div>
                </div>

                ${currentPeriod === 'day' ? renderCompareSection() : ''}

                ${currentPeriod === 'week' ? renderWeeklyCalendar() : ''}
                ${currentPeriod === 'month' ? renderMonthlyCalendar() : ''}
                ${currentPeriod === 'year' ? renderYearlyCalendar() : ''}
                ${currentPeriod === 'day' ? renderHeatmapSection(filteredCards) : ''}
                ${renderDayTimeMatrix(filteredCards)}

                <div class="chart-container">
                    <h2 class="chart-title">å…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§</h2>
                    <p style="text-align: center; color: #a0a0a0; margin-bottom: 20px;">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</p>
                    ${renderAreaSections(filteredCards, areas)}
                </div>
            `;

            // å…¨ä½“ã‚°ãƒ©ãƒ•ã‚’æç”»
            renderOverviewChart(filteredCards);

            // ãŠæ°—ã«å…¥ã‚Šãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const favToggleBtn = document.getElementById('favToggleBtn');
            if (favToggleBtn) {
                favToggleBtn.addEventListener('click', () => {
                    showFavoritesOnly = !showFavoritesOnly;
                    showAllRides();
                });
            }

            // å‰å›ã®æ¥åœ’æ—¥ã¨æ¯”è¼ƒï¼ˆæ—¥ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰ï¼šãƒœã‚¿ãƒ³ãƒ»å¹´æœˆå¤‰æ›´ã§æ—¥ã®é¸æŠè‚¢ã‚’æ›´æ–°
            if (currentPeriod === 'day') {
                const compareBtn = document.getElementById('compareBtn');
                if (compareBtn) compareBtn.addEventListener('click', runCompare);
                updateCompareDayOptions();
                const compareYear = document.getElementById('compareYear');
                const compareMonth = document.getElementById('compareMonth');
                if (compareYear) compareYear.addEventListener('change', updateCompareDayOptions);
                if (compareMonth) compareMonth.addEventListener('change', updateCompareDayOptions);
            }

            // ã‚¨ãƒªã‚¢ã‚¿ãƒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰
            content.querySelectorAll('.area-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const area = tab.dataset.area;
                    
                    if (area === 'all') {
                        // ã€Œã™ã¹ã¦ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ å…¨é¸æŠï¼ˆé…åˆ—ã‚’ç©ºã«ï¼‰
                        selectedAreas = [];
                    } else {
                        // å€‹åˆ¥ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒˆã‚°ãƒ«
                        if (selectedAreas.includes(area)) {
                            // é¸æŠè§£é™¤
                            selectedAreas = selectedAreas.filter(a => a !== area);
                            // å…¨éƒ¨æœªé¸æŠã«ãªã£ãŸã‚‰è‡ªå‹•çš„ã«ã™ã¹ã¦é¸æŠ
                            // ï¼ˆselectedAreas ãŒç©º = ã™ã¹ã¦é¸æŠãªã®ã§ä½•ã‚‚ã—ãªãã¦OKï¼‰
                        } else {
                            // é¸æŠè¿½åŠ 
                            selectedAreas.push(area);
                        }
                    }
                    showAllRides();
                });
            });

            // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            content.querySelectorAll('.ride-card').forEach(card => {
                card.addEventListener('click', () => {
                    const rideId = parseInt(card.dataset.rideId);
                    document.getElementById('rideSelect').value = rideId;
                    showRideDetail(rideId);
                });
            });

            // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã¨ã¯ç‹¬ç«‹ã•ã›ã‚‹ï¼‰
            content.querySelectorAll('.ride-card-fav-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const rideId = btn.dataset.rideId;
                    if (!rideId) return;
                    toggleFavoriteRide(rideId);
                    // ç”»é¢ã‚’å†æç”»ã—ã¦çŠ¶æ…‹ã‚’åæ˜ 
                    showAllRides();
                });
            });
        }

        function renderOverviewChart(rideCards) {
            const ctx = document.getElementById('overviewChart');
            if (!ctx) return;

            if (overviewChart) {
                overviewChart.destroy();
            }

            // æ‹¡å¼µã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
            const colors = [
                '#4ecdc4', '#ff6b6b', '#f9ca24', '#45b7d1', '#e84393',
                '#00b894', '#fdcb6e', '#6c5ce7', '#fd79a8', '#00cec9',
                '#e17055', '#74b9ff', '#a29bfe', '#55efc4', '#ffeaa7',
                '#dfe6e9', '#81ecec', '#fab1a0', '#ff7675', '#636e72',
                '#b2bec3', '#2d3436', '#d63031', '#e84393', '#0984e3',
                '#6c5ce7', '#00b894', '#fdcb6e', '#e17055', '#74b9ff',
                '#a29bfe', '#55efc4', '#ffeaa7', '#dfe6e9', '#81ecec',
                '#fab1a0', '#ff7675', '#636e72', '#b2bec3', '#2d3436'
            ];

            // å…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¹³å‡å¾…ã¡æ™‚é–“ãŒé•·ã„é †ã«ã‚½ãƒ¼ãƒˆï¼‰
            const allRides = [...rideCards]
                .filter(r => r.avgWait > 0)
                .sort((a, b) => b.avgWait - a.avgWait);

            let labels, datasets, xAxisTitle;

            if (currentPeriod === 'day') {
                // æ—¥å˜ä½: 9:00ã€œ21:00 ã‚’30åˆ†åˆ»ã¿ã§è¡¨ç¤º
                labels = [];
                for (let h = 9; h <= 21; h++) {
                    labels.push(`${h.toString().padStart(2, '0')}:00`);
                    if (h !== 21) {
                        labels.push(`${h.toString().padStart(2, '0')}:30`);
                    }
                }
                xAxisTitle = 'æ™‚åˆ»';

                datasets = allRides.map((ride, index) => {
                    // 9:00ã€œ21:00 ã‚’30åˆ†åˆ»ã¿
                    const slotData = new Array(labels.length).fill(null);
                    for (const td of ride.timeData) {
                        if (td.wait !== null) {
                            const [hours, minutes] = td.time.split(':').map(Number);
                            if (hours < 9 || hours > 21) continue;
                            // 9:00 ã‚’ 0ã€9:30 ã‚’ 1 ... 21:00 ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                            const baseIndex = (hours - 9) * 2;
                            const index30 = minutes >= 30 ? baseIndex + 1 : baseIndex;
                            if (index30 >= 0 && index30 < slotData.length) {
                                slotData[index30] = td.wait;
                            }
                        }
                    }
                    return {
                        label: ride.name,
                        data: slotData,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false, tension: 0.4, spanGaps: true, pointRadius: 6, pointHoverRadius: 10, borderWidth: 4, hidden: false,
                        rideId: ride.id
                    };
                });
            } else if (currentPeriod === 'week') {
                // é€±å˜ä½: é¸æŠã—ãŸé€±ï¼ˆå¿…ãšæ—¥æ›œå§‹ã¾ã‚Šï¼‰ã®7æ—¥åˆ†ã‚’ X è»¸ã«è¡¨ç¤ºï¼ˆä¾‹: 2/5(æœ¨)ï¼‰
                const weekStartStr = loadedData?.selectedValue; // ãã®é€±ã®æ—¥æ›œæ—¥ï¼ˆYYYY-MM-DDï¼‰
                const weekDates = [];
                if (weekStartStr) {
                    const weekStart = parseDateStringToLocalDate(weekStartStr);
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(weekStart);
                        d.setDate(weekStart.getDate() + i);
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        weekDates.push(`${y}-${m}-${day}`);
                    }
                }
                labels = weekDates.map(d => formatWeekDateLabel(d));
                xAxisTitle = 'æ—¥ä»˜';

                datasets = allRides.map((ride, index) => {
                    const dayData = new Array(weekDates.length).fill(null);
                    const dayWaits = weekDates.map(() => []);
                    
                    for (const td of ride.timeData) {
                        if (td.wait !== null && td.date) {
                            const pos = weekDates.indexOf(td.date);
                            if (pos !== -1) {
                                dayWaits[pos].push(td.wait);
                            }
                        }
                    }
                    
                    for (let i = 0; i < weekDates.length; i++) {
                        if (dayWaits[i].length > 0) {
                            dayData[i] = Math.round(dayWaits[i].reduce((a, b) => a + b, 0) / dayWaits[i].length);
                        }
                    }
                    
                    return {
                        label: ride.name,
                        data: dayData,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false, tension: 0.4, spanGaps: true, pointRadius: 6, pointHoverRadius: 10, borderWidth: 4, hidden: false,
                        rideId: ride.id
                    };
                });
            } else if (currentPeriod === 'month') {
                // æœˆå˜ä½: æ—¥ä»˜è»¸ï¼ˆãã®æœˆã®å…¨æ—¥ä»˜ã‚’è¡¨ç¤ºï¼‰
                const selectedMonth = loadedData.selectedValue || '';
                const [year, month] = selectedMonth.split('-');
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                
                // ãã®æœˆã®å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
                const allDatesInMonth = [];
                for (let d = 1; d <= daysInMonth; d++) {
                    allDatesInMonth.push(`${year}-${month}-${d.toString().padStart(2, '0')}`);
                }
                
                labels = allDatesInMonth.map(d => parseInt(d.split('-')[2]) + 'æ—¥');
                xAxisTitle = 'æ—¥ä»˜';

                datasets = allRides.map((ride, index) => {
                    const dateMap = {};
                    for (const td of ride.timeData) {
                        if (td.wait !== null && td.date) {
                            if (!dateMap[td.date]) dateMap[td.date] = [];
                            dateMap[td.date].push(td.wait);
                        }
                    }
                    
                    const dayData = allDatesInMonth.map(date => {
                        if (dateMap[date] && dateMap[date].length > 0) {
                            return Math.round(dateMap[date].reduce((a, b) => a + b, 0) / dateMap[date].length);
                        }
                        return null;
                    });
                    
                    return {
                        label: ride.name,
                        data: dayData,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false, tension: 0.4, spanGaps: true, pointRadius: 6, pointHoverRadius: 10, borderWidth: 4, hidden: false,
                        rideId: ride.id
                    };
                });
            } else {
                // å¹´å˜ä½: æœˆè»¸
                labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                xAxisTitle = 'æœˆ';

                datasets = allRides.map((ride, index) => {
                    const monthWaits = Array(12).fill(null).map(() => []);
                    
                    for (const td of ride.timeData) {
                        if (td.wait !== null && td.date) {
                            const month = parseInt(td.date.split('-')[1]) - 1;
                            monthWaits[month].push(td.wait);
                        }
                    }
                    
                    const monthData = monthWaits.map(waits => {
                        if (waits.length > 0) {
                            return Math.round(waits.reduce((a, b) => a + b, 0) / waits.length);
                        }
                        return null;
                    });
                    
                    return {
                        label: ride.name,
                        data: monthData,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false, tension: 0.4, spanGaps: true, pointRadius: 6, pointHoverRadius: 10, borderWidth: 4, hidden: false,
                        rideId: ride.id
                    };
                });
            }

            // Xè»¸ã®tickè¨­å®šã‚’æœŸé–“ã«å¿œã˜ã¦è¨­å®š
            const xTicksConfig = {
                color: '#a0a0a0',
                maxRotation: currentPeriod === 'month' ? 45 : 0,
                font: { size: 14, weight: 'bold' }
            };
            if (currentPeriod === 'day') {
                // 30åˆ†åˆ»ã¿ãƒ‡ãƒ¼ã‚¿ã ãŒã€ãƒ©ãƒ™ãƒ«ã¯1æ™‚é–“ã”ã¨ã«è¡¨ç¤º
                xTicksConfig.callback = function(val, index) { 
                    return index % 2 === 0 ? this.getLabelForValue(val) : ''; 
                };
            } else if (currentPeriod === 'month' && labels.length > 15) {
                xTicksConfig.callback = function(val, index) { 
                    return index % 5 === 0 ? this.getLabelForValue(val) : ''; 
                };
            }

            overviewChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'nearest',
                        intersect: true
                    },
                    onClick: (event) => {
                        if (!overviewChart) return;

                        // Chart.js ã®ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                        const nativeEvent = event && event.native ? event.native : event;

                        // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«æœ€ã‚‚è¿‘ã„ãƒã‚¤ãƒ³ãƒˆç¾¤ã‚’å–å¾—ï¼ˆYæ–¹å‘ã‚’å«ã‚€è·é›¢ã§åˆ¤å®šï¼‰
                        const nearestPoints = overviewChart.getElementsAtEventForMode(
                            event,
                            'nearest',
                            { intersect: true },
                            false
                        );
                        if (!nearestPoints.length) return;

                        const labels = overviewChart.data.labels;
                        const datasets = overviewChart.data.datasets;

                        // ã€Œä¸€ç•ªè¿‘ã„ãƒã‚¤ãƒ³ãƒˆã€ã® datasetIndex / index ã‚’ãƒ™ãƒ¼ã‚¹ã«å€™è£œã‚’ä½œæˆ
                        // ï¼ˆXã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§æ¨ªä¸€åˆ—ã‚’æ‹¾ã†ã®ã§ã¯ãªãã€nearest ãŒè¿”ã—ãŸãƒã‚¤ãƒ³ãƒˆã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼‰
                        const candidates = [];
                        const seen = new Set();

                        nearestPoints.forEach(pt => {
                            const dsIndex = pt.datasetIndex;
                            const idx = pt.index;
                            const ds = datasets[dsIndex];
                            if (!ds) return;

                            const meta = overviewChart.getDatasetMeta(dsIndex);
                            const value = ds.data[idx];
                            const rideId = ds.rideId;
                            if (value == null || meta.hidden) return;
                            if (typeof rideId !== 'number' || isNaN(rideId)) return;

                            const key = `${rideId}-${idx}`;
                            if (seen.has(key)) return;
                            seen.add(key);

                            candidates.push({
                                rideId,
                                name: ds.label,
                                wait: value,
                                timeLabel: labels[idx]
                            });
                        });

                        if (!candidates.length || !nativeEvent) return;

                        if (candidates.length === 1) {
                            const target = candidates[0];
                            const rideSelect = document.getElementById('rideSelect');
                            if (rideSelect) {
                                rideSelect.value = String(target.rideId);
                            }
                            showRideDetail(target.rideId);
                            return;
                        }

                        // è¤‡æ•°é‡ãªã£ã¦ã„ã‚‹å ´åˆã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§é¸æŠ
                        showPointPopup(candidates, nativeEvent);
                    },
                    plugins: {
                        legend: {
                            display: false // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚’ä½¿ç”¨
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.raw === null) return null;
                                    return `${context.dataset.label}: ${context.raw}åˆ†`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: xTicksConfig,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: xAxisTitle,
                                color: '#a0a0a0',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a0a0a0', font: { size: 14, weight: 'bold' } },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: 'å¾…ã¡æ™‚é–“ï¼ˆåˆ†ï¼‰',
                                color: '#a0a0a0',
                                font: { size: 16, weight: 'bold' }
                            }
                        }
                    }
                }
            });

            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚’ç”Ÿæˆ
            const legendContainer = document.getElementById('chartLegend');
            if (legendContainer) {
                legendContainer.innerHTML = datasets.map((ds, i) => `
                    <div class="legend-item ${ds.hidden ? 'hidden' : ''}" data-index="${i}">
                        <span class="legend-color" style="background: ${ds.borderColor}"></span>
                        <span>${escapeHtml(ds.label)}</span>
                    </div>
                `).join('');

                // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                legendContainer.querySelectorAll('.legend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const index = parseInt(item.dataset.index);
                        const meta = overviewChart.getDatasetMeta(index);
                        meta.hidden = !meta.hidden;
                        item.classList.toggle('hidden', meta.hidden);
                        overviewChart.update();
                    });
                });
            }

            // ãŠã™ã™ã‚æ¥åœ’æ™‚é–“ã‚µãƒãƒªãƒ¼ã‚’æç”»ï¼ˆé€±ãƒ»æœˆãƒ»å¹´ã®ã¨ãï¼‰
            const summaryContainer = document.getElementById('visitSummary');
            if (summaryContainer) {
                const summary = computeVisitSummary();
                if (!summary) {
                    summaryContainer.innerHTML = '';
                    summaryContainer.style.display = 'none';
                } else {
                    summaryContainer.style.display = 'block';
                    summaryContainer.innerHTML = `
                        <div class="visit-summary-title">${summary.title}</div>
                        <div class="visit-summary-items">
                            ${summary.items.map(item => `
                                <div class="visit-summary-item">
                                    <span class="visit-summary-rank">${item.rank}ä½</span>
                                    <span>${item.label}</span>
                                    <span>ï¼ˆå¹³å‡ ${item.avgMinutes}åˆ†ï¼‰</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
        }

        function renderHeatmapSection(rideCards) {
            if (!rideCards || rideCards.length === 0 || !loadedData || !loadedData.records.length) {
                return '';
            }

            // 9:00ã€œ21:00 ã‚’30åˆ†åˆ»ã¿ã§ã‚¹ãƒ­ãƒƒãƒˆåŒ–
            const slots = [];
            for (let h = 9; h <= 21; h++) {
                const hh = h.toString().padStart(2, '0');
                slots.push(`${hh}:00`);
                if (h !== 21) slots.push(`${hh}:30`);
            }

            const rowsHtml = rideCards.map(ride => {
                const sums = new Array(slots.length).fill(0);
                const counts = new Array(slots.length).fill(0);

                for (const td of ride.timeData) {
                    if (td.wait == null || !td.time) continue;
                    const [hours, minutes] = td.time.split(':').map(Number);
                    if (hours < 9 || hours > 21) continue;
                    const base = (hours - 9) * 2;
                    const idx = minutes >= 30 ? base + 1 : base;
                    if (idx < 0 || idx >= slots.length) continue;
                    sums[idx] += td.wait;
                    counts[idx] += 1;
                }

                const cells = sums.map((sum, i) => {
                    if (!counts[i]) {
                        return '<td class="heatmap-cell heat-none"></td>';
                    }
                    const avg = Math.round(sum / counts[i]);
                    const waitClass = getWaitClass(avg) || '';
                    return `<td class="heatmap-cell ${waitClass || 'heat-none'}">${avg}</td>`;
                }).join('');

                return `
                    <tr>
                        <td class="heatmap-ride-name">${escapeHtml(ride.name)}</td>
                        ${cells}
                    </tr>
                `;
            }).join('');

            const headerCells = slots.map(t => `<th class="heatmap-header">${t}</th>`).join('');

            return `
                <div class="heatmap-container">
                    <h3 class="heatmap-title">â± æ··é›‘ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆ9:00ã€œ21:00ï¼‰</h3>
                    <div class="heatmap-note">è‰²ãŒæ¿ƒã„ã»ã©å¹³å‡å¾…ã¡æ™‚é–“ãŒé•·ã„æ™‚é–“å¸¯ã§ã™ã€‚</div>
                    <div class="heatmap-table-wrapper">
                        <table class="heatmap-table">
                            <thead>
                                <tr>
                                    <th class="heatmap-header">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</th>
                                    ${headerCells}
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderMonthlyCalendar() {
            if (!loadedData || loadedData.period !== 'month') return '';

            const value = loadedData.selectedValue; // "YYYY-MM"
            if (!value) return '';

            const [yearStr, monthStr] = value.split('-');
            const year = parseInt(yearStr, 10);
            const month = parseInt(monthStr, 10);
            if (!year || !month) return '';

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆ
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const rec of loadedData.records) {
                if (!rec.date) continue;
                if (!dailyStats.has(rec.date)) {
                    dailyStats.set(rec.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(rec.date);
                for (const ride of rec.rides) {
                    if (ride.is_open && ride.wait_time > 0) {
                        stat.sum += ride.wait_time;
                        stat.count += 1;
                    }
                }
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ çµ„ã¿ï¼ˆãã®æœˆã®1æ—¥ã€œæœ«æ—¥ï¼‰
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const firstWeekday = firstDay.getDay(); // 0=æ—¥
            const totalDays = lastDay.getDate();

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            const cells = [];

            // æ›œæ—¥ãƒ˜ãƒƒãƒ€
            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            // ç©ºç™½ã‚»ãƒ«ï¼ˆ1æ—¥ãŒå§‹ã¾ã‚‹å‰ã¾ã§ï¼‰
            for (let i = 0; i < firstWeekday; i++) {
                cells.push('<div></div>');
            }

            // å„æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= totalDays; day++) {
                const d = String(day).padStart(2, '0');
                const monthPadded = String(month).padStart(2, '0');
                const dateStr = `${year}-${monthPadded}-${d}`;

                const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                const hasData = avg != null;
                const weekday = new Date(year, month - 1, day).getDay();

                const waitClass = hasData ? getWaitClass(avg) : '';
                const disabledClass = loadedData.dateRange.includes(dateStr) && hasData ? '' : 'disabled';
                const label = hasData ? `${Math.round(avg)}åˆ†` : '-';

                const cellHtml = `
                    <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                        <div class="calendar-day-header">
                            <span class="calendar-day-date">${day}</span>
                            <span class="calendar-day-weekday">${weekdays[weekday]}</span>
                        </div>
                        <div class="calendar-day-value">${label}</div>
                    </div>
                `;
                cells.push(cellHtml);
            }

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="calendar-grid">
                        ${headerRow}
                        ${cells.join('')}
                    </div>
                </div>
            `;
        }

        function renderYearlyCalendar() {
            if (!loadedData || loadedData.period !== 'year') return '';

            const value = loadedData.selectedValue; // "YYYY"
            if (!value) return '';

            const year = parseInt(value, 10);
            if (!year) return '';

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆ
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const rec of loadedData.records) {
                if (!rec.date) continue;
                if (!dailyStats.has(rec.date)) {
                    dailyStats.set(rec.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(rec.date);
                for (const ride of rec.rides) {
                    if (ride.is_open && ride.wait_time > 0) {
                        stat.sum += ride.wait_time;
                        stat.count += 1;
                    }
                }
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            let calendarsHtml = '';

            // 12ãƒ¶æœˆåˆ†ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            for (let month = 1; month <= 12; month++) {
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const firstWeekday = firstDay.getDay();
                const totalDays = lastDay.getDate();

                const cells = [];

                // ç©ºç™½ã‚»ãƒ«ï¼ˆ1æ—¥ãŒå§‹ã¾ã‚‹å‰ã¾ã§ï¼‰
                for (let i = 0; i < firstWeekday; i++) {
                    cells.push('<div></div>');
                }

                // å„æ—¥ä»˜ã‚»ãƒ«
                for (let day = 1; day <= totalDays; day++) {
                    const d = String(day).padStart(2, '0');
                    const monthPadded = String(month).padStart(2, '0');
                    const dateStr = `${year}-${monthPadded}-${d}`;

                    const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                    const hasData = avg != null;
                    const weekday = new Date(year, month - 1, day).getDay();

                    const waitClass = hasData ? getWaitClass(avg) : '';
                    const disabledClass = loadedData.dateRange.includes(dateStr) && hasData ? '' : 'disabled';
                    const label = hasData ? `${Math.round(avg)}åˆ†` : '-';

                    const cellHtml = `
                        <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                            <div class="calendar-day-header">
                                <span class="calendar-day-date">${day}</span>
                                <span class="calendar-day-weekday">${weekdays[weekday]}</span>
                            </div>
                            <div class="calendar-day-value">${label}</div>
                        </div>
                    `;
                    cells.push(cellHtml);
                }

                calendarsHtml += `
                    <div class="year-calendar-month">
                        <h4 class="year-calendar-month-title">${year}å¹´${monthNames[month - 1]}</h4>
                        <div class="calendar-grid">
                            ${headerRow}
                            ${cells.join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ${year}å¹´ï¼‰</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="year-calendars-wrapper">
                        ${calendarsHtml}
                    </div>
                </div>
            `;
        }

        // é€±ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰
        function renderWeeklyCalendar() {
            if (!loadedData || loadedData.period !== 'week') return '';

            const weekStartStr = loadedData.selectedValue; // ãã®é€±ã®æ—¥æ›œæ—¥ï¼ˆYYYY-MM-DDï¼‰
            if (!weekStartStr) return '';

            const weekStart = parseDateStringToLocalDate(weekStartStr);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                weekDates.push(`${y}-${m}-${day}`);
            }

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆ
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const rec of loadedData.records) {
                if (!rec.date) continue;
                if (!dailyStats.has(rec.date)) {
                    dailyStats.set(rec.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(rec.date);
                for (const ride of rec.rides) {
                    if (ride.is_open && ride.wait_time > 0) {
                        stat.sum += ride.wait_time;
                        stat.count += 1;
                    }
                }
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            const cells = weekDates.map((dateStr, i) => {
                const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                const hasData = avg != null;
                const waitClass = hasData ? getWaitClass(avg) : '';
                const disabledClass = hasData ? '' : 'disabled';
                const label = hasData ? `${Math.round(avg)}åˆ†` : '-';
                const day = parseInt(dateStr.split('-')[2], 10);

                return `
                    <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                        <div class="calendar-day-header">
                            <span class="calendar-day-date">${day}</span>
                            <span class="calendar-day-weekday">${weekdays[i]}</span>
                        </div>
                        <div class="calendar-day-value">${label}</div>
                    </div>
                `;
            });

            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="calendar-grid">
                        ${headerRow}
                        ${cells.join('')}
                    </div>
                </div>
            `;
        }

        // å€‹åˆ¥ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç”¨é€±ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        function renderSingleRideWeeklyCalendar(rideId, rideData) {
            if (!loadedData || loadedData.period !== 'week' || !rideData || rideData.length === 0) return '';

            const weekStartStr = loadedData.selectedValue; // ãã®é€±ã®æ—¥æ›œæ—¥ï¼ˆYYYY-MM-DDï¼‰
            if (!weekStartStr) return '';

            const weekStart = parseDateStringToLocalDate(weekStartStr);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                weekDates.push(`${y}-${m}-${day}`);
            }

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆï¼ˆã“ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const d of rideData) {
                if (!d.date) continue;
                if (!d.is_open || d.wait_time == null || d.wait_time <= 0) continue;
                if (!dailyStats.has(d.date)) {
                    dailyStats.set(d.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(d.date);
                stat.sum += d.wait_time;
                stat.count += 1;
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            const cells = weekDates.map((dateStr, i) => {
                const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                const hasData = avg != null;
                const waitClass = hasData ? getWaitClass(avg) : '';
                const disabledClass = hasData ? '' : 'disabled';
                const label = hasData ? `${Math.round(avg)}åˆ†` : '-';
                const day = parseInt(dateStr.split('-')[2], 10);

                return `
                    <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                        <div class="calendar-day-header">
                            <span class="calendar-day-date">${day}</span>
                            <span class="calendar-day-weekday">${weekdays[i]}</span>
                        </div>
                        <div class="calendar-day-value">${label}</div>
                    </div>
                `;
            });

            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="calendar-grid">
                        ${headerRow}
                        ${cells.join('')}
                    </div>
                </div>
            `;
        }

        // â”€â”€ æ›œæ—¥Ã—æ™‚é–“å¸¯ãƒãƒˆãƒªã‚¯ã‚¹ â”€â”€

        function buildDayTimeMatrix(dataIterator) {
            // 7æ›œæ—¥ x 13æ™‚é–“å¸¯ (9ã€œ21æ™‚) ã®é›†è¨ˆç”¨ãƒãƒˆãƒªã‚¯ã‚¹
            const matrix = Array.from({ length: 7 }, () =>
                Array.from({ length: 13 }, () => ({ sum: 0, count: 0 }))
            );

            for (const item of dataIterator) {
                const cell = matrix[item.dow][item.hourIdx];
                cell.sum += item.wait;
                cell.count += 1;
            }

            return matrix;
        }

        function renderDayTimeMatrixHtml(matrix, title, options) {
            const onlyDow = options && options.onlyDow !== undefined ? options.onlyDow : null;
            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const hourSlots = [];
            for (let h = 9; h <= 21; h++) hourSlots.push(h);

            // æ›œæ—¥ã”ã¨ã®æœ€å°å€¤ã‚»ãƒ«ã‚’æ¢ã™
            const bestPerDay = []; // { hourIdx, avg } or null
            for (let dow = 0; dow < 7; dow++) {
                let bestHi = -1, bestAvg = Infinity;
                for (let hi = 0; hi < hourSlots.length; hi++) {
                    const c = matrix[dow][hi];
                    if (c.count > 0) {
                        const avg = c.sum / c.count;
                        if (avg < bestAvg) {
                            bestAvg = avg;
                            bestHi = hi;
                        }
                    }
                }
                bestPerDay.push(bestHi >= 0 ? { hourIdx: bestHi, avg: bestAvg } : null);
            }

            const headerCells = hourSlots.map(h => `<th class="heatmap-header">${h}æ™‚</th>`).join('');

            const rowsToRender = onlyDow !== null ? [onlyDow] : [0, 1, 2, 3, 4, 5, 6];
            const rowsHtml = rowsToRender.map(dow => {
                const label = dayLabels[dow];
                const best = bestPerDay[dow];
                const cells = hourSlots.map((h, hi) => {
                    const c = matrix[dow][hi];
                    if (!c.count) {
                        return '<td class="heatmap-cell heat-none">-</td>';
                    }
                    const avg = Math.round(c.sum / c.count);
                    const waitClass = getWaitClass(avg) || '';
                    const bestClass = (best && hi === best.hourIdx) ? ' matrix-best-cell' : '';
                    return `<td class="heatmap-cell ${waitClass || 'heat-none'}${bestClass}">${avg}</td>`;
                }).join('');

                return `<tr><td class="matrix-day-label">${label}</td>${cells}</tr>`;
            }).join('');

            const tipHtml = '';
            const noteText = onlyDow !== null
                ? 'ãã®æ—¥ã®æ™‚é–“å¸¯åˆ¥å¹³å‡å¾…ã¡æ™‚é–“ã§ã™ã€‚é»„è‰²æ ãŒç‹™ã„ç›®ã§ã™ã€‚'
                : 'è“„ç©ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ›œæ—¥Ã—æ™‚é–“å¸¯ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚é»„è‰²æ ãŒå„æ›œæ—¥ã®ç‹™ã„ç›®ã§ã™ã€‚';

            return `
                <div class="heatmap-container">
                    <h3 class="heatmap-title">${title}</h3>
                    <div class="heatmap-note">${noteText}</div>
                    <div class="heatmap-table-wrapper">
                        <table class="heatmap-table">
                            <thead>
                                <tr>
                                    <th class="heatmap-header">æ›œæ—¥</th>
                                    ${headerCells}
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>
                    ${tipHtml}
                </div>
            `;
        }

        function renderDayTimeMatrix(filteredCards) {
            if (!filteredCards || filteredCards.length === 0) return '';

            // å…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åˆç®—ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚’ä½œæˆ
            const items = [];
            for (const ride of filteredCards) {
                for (const td of ride.timeData) {
                    if (td.wait == null || !td.time || !td.date) continue;
                    const hour = parseInt(td.time.split(':')[0], 10);
                    if (hour < 9 || hour > 21) continue;
                    const [y, m, d] = td.date.split('-').map(Number);
                    const dow = new Date(y, m - 1, d).getDay();
                    items.push({ dow, hourIdx: hour - 9, wait: td.wait });
                }
            }

            if (items.length === 0) return '';

            const matrix = buildDayTimeMatrix(items);
            const title = currentPeriod === 'day' ? 'ğŸ“… ä»Šæ—¥ã®ãŠã™ã™ã‚æ™‚é–“å¸¯' : 'ğŸ“… æ›œæ—¥åˆ¥ãŠã™ã™ã‚æ™‚é–“å¸¯';
            let onlyDow = null;
            if (currentPeriod === 'day' && loadedData && (loadedData.dateRange?.length > 0 || loadedData.selectedValue)) {
                const dateStr = loadedData.dateRange?.[0] || loadedData.selectedValue;
                const [y, m, d] = dateStr.split('-').map(Number);
                onlyDow = new Date(y, m - 1, d).getDay();
            }
            return renderDayTimeMatrixHtml(matrix, title, { onlyDow });
        }

        function renderSingleRideDayTimeMatrix(rideId, rideName, rideData) {
            if (!rideData || rideData.length === 0) return '';

            const items = [];
            for (const d of rideData) {
                if (!d.is_open || d.wait_time == null || d.wait_time <= 0 || !d.time || !d.date) continue;
                const hour = parseInt(d.time.split(':')[0], 10);
                if (hour < 9 || hour > 21) continue;
                const [y, m, day] = d.date.split('-').map(Number);
                const dow = new Date(y, m - 1, day).getDay();
                items.push({ dow, hourIdx: hour - 9, wait: d.wait_time });
            }

            if (items.length === 0) return '';

            const matrix = buildDayTimeMatrix(items);
            const title = currentPeriod === 'day' ? 'ğŸ“… ä»Šæ—¥ã®ãŠã™ã™ã‚æ™‚é–“å¸¯' : 'ğŸ“… æ›œæ—¥åˆ¥ãŠã™ã™ã‚æ™‚é–“å¸¯';
            let onlyDow = null;
            if (currentPeriod === 'day' && rideData.length > 0 && rideData[0].date) {
                const [y, m, d] = rideData[0].date.split('-').map(Number);
                onlyDow = new Date(y, m - 1, d).getDay();
            }
            return renderDayTimeMatrixHtml(matrix, title, { onlyDow });
        }

        // å€‹åˆ¥ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç”¨ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆæ—¥å˜ä½ï¼‰
        function renderSingleRideHeatmap(rideId, rideName, rideData) {
            if (!rideData || rideData.length === 0 || currentPeriod !== 'day') {
                return '';
            }

            // 9:00ã€œ21:00 ã‚’30åˆ†åˆ»ã¿ã§ã‚¹ãƒ­ãƒƒãƒˆåŒ–
            const slots = [];
            for (let h = 9; h <= 21; h++) {
                const hh = h.toString().padStart(2, '0');
                slots.push(`${hh}:00`);
                if (h !== 21) slots.push(`${hh}:30`);
            }

            const sums = new Array(slots.length).fill(0);
            const counts = new Array(slots.length).fill(0);

            for (const d of rideData) {
                if (!d.is_open || d.wait_time == null || !d.time) continue;
                const [hours, minutes] = d.time.split(':').map(Number);
                if (hours < 9 || hours > 21) continue;
                const base = (hours - 9) * 2;
                const idx = minutes >= 30 ? base + 1 : base;
                if (idx < 0 || idx >= slots.length) continue;
                sums[idx] += d.wait_time;
                counts[idx] += 1;
            }

            const cells = sums.map((sum, i) => {
                if (!counts[i]) {
                    return '<td class="heatmap-cell heat-none">-</td>';
                }
                const avg = Math.round(sum / counts[i]);
                const waitClass = getWaitClass(avg) || '';
                return `<td class="heatmap-cell ${waitClass || 'heat-none'}">${avg}</td>`;
            }).join('');

            const headerCells = slots.map(t => `<th class="heatmap-header">${t}</th>`).join('');

            return `
                <div class="heatmap-container">
                    <h3 class="heatmap-title">â± æ™‚é–“å¸¯åˆ¥ æ··é›‘ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆ9:00ã€œ21:00ï¼‰</h3>
                    <div class="heatmap-note">è‰²ãŒæ¿ƒã„ã»ã©å¾…ã¡æ™‚é–“ãŒé•·ã„æ™‚é–“å¸¯ã§ã™ã€‚</div>
                    <div class="heatmap-table-wrapper">
                        <table class="heatmap-table">
                            <thead>
                                <tr>
                                    <th class="heatmap-header">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</th>
                                    ${headerCells}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="heatmap-ride-name">${escapeHtml(rideName)}</td>
                                    ${cells}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // å€‹åˆ¥ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç”¨æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        function renderSingleRideMonthlyCalendar(rideId, rideData) {
            if (!loadedData || loadedData.period !== 'month' || !rideData || rideData.length === 0) return '';

            const value = loadedData.selectedValue; // "YYYY-MM"
            if (!value) return '';

            const [yearStr, monthStr] = value.split('-');
            const year = parseInt(yearStr, 10);
            const month = parseInt(monthStr, 10);
            if (!year || !month) return '';

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆï¼ˆã“ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const d of rideData) {
                if (!d.date) continue;
                if (!d.is_open || d.wait_time == null || d.wait_time <= 0) continue;
                if (!dailyStats.has(d.date)) {
                    dailyStats.set(d.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(d.date);
                stat.sum += d.wait_time;
                stat.count += 1;
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ çµ„ã¿ï¼ˆãã®æœˆã®1æ—¥ã€œæœ«æ—¥ï¼‰
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const firstWeekday = firstDay.getDay(); // 0=æ—¥
            const totalDays = lastDay.getDate();

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            const cells = [];

            // æ›œæ—¥ãƒ˜ãƒƒãƒ€
            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            // ç©ºç™½ã‚»ãƒ«ï¼ˆ1æ—¥ãŒå§‹ã¾ã‚‹å‰ã¾ã§ï¼‰
            for (let i = 0; i < firstWeekday; i++) {
                cells.push('<div></div>');
            }

            // å„æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= totalDays; day++) {
                const d = String(day).padStart(2, '0');
                const monthPadded = String(month).padStart(2, '0');
                const dateStr = `${year}-${monthPadded}-${d}`;

                const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                const hasData = avg != null;
                const weekday = new Date(year, month - 1, day).getDay();

                const waitClass = hasData ? getWaitClass(avg) : '';
                const disabledClass = hasData ? '' : 'disabled';
                const label = hasData ? `${Math.round(avg)}åˆ†` : '-';

                const cellHtml = `
                    <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                        <div class="calendar-day-header">
                            <span class="calendar-day-date">${day}</span>
                            <span class="calendar-day-weekday">${weekdays[weekday]}</span>
                        </div>
                        <div class="calendar-day-value">${label}</div>
                    </div>
                `;
                cells.push(cellHtml);
            }

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="calendar-grid">
                        ${headerRow}
                        ${cells.join('')}
                    </div>
                </div>
            `;
        }

        // å€‹åˆ¥ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ç”¨å¹´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        function renderSingleRideYearlyCalendar(rideId, rideData) {
            if (!loadedData || loadedData.period !== 'year' || !rideData || rideData.length === 0) return '';

            const value = loadedData.selectedValue; // "YYYY"
            if (!value) return '';

            const year = parseInt(value, 10);
            if (!year) return '';

            // æ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ã‚’é›†è¨ˆï¼ˆã“ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
            const dailyStats = new Map(); // date(YYYY-MM-DD) -> { sum, count }
            for (const d of rideData) {
                if (!d.date) continue;
                if (!d.is_open || d.wait_time == null || d.wait_time <= 0) continue;
                if (!dailyStats.has(d.date)) {
                    dailyStats.set(d.date, { sum: 0, count: 0 });
                }
                const stat = dailyStats.get(d.date);
                stat.sum += d.wait_time;
                stat.count += 1;
            }

            const dateToAvg = new Map(); // date -> avgMinutes
            dailyStats.forEach((stat, date) => {
                if (stat.count > 0) {
                    dateToAvg.set(date, stat.sum / stat.count);
                }
            });

            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const headerRow = weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('');

            let calendarsHtml = '';

            // 12ãƒ¶æœˆåˆ†ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            for (let month = 1; month <= 12; month++) {
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const firstWeekday = firstDay.getDay();
                const totalDays = lastDay.getDate();

                const cells = [];

                // ç©ºç™½ã‚»ãƒ«ï¼ˆ1æ—¥ãŒå§‹ã¾ã‚‹å‰ã¾ã§ï¼‰
                for (let i = 0; i < firstWeekday; i++) {
                    cells.push('<div></div>');
                }

                // å„æ—¥ä»˜ã‚»ãƒ«
                for (let day = 1; day <= totalDays; day++) {
                    const d = String(day).padStart(2, '0');
                    const monthPadded = String(month).padStart(2, '0');
                    const dateStr = `${year}-${monthPadded}-${d}`;

                    const avg = dateToAvg.has(dateStr) ? dateToAvg.get(dateStr) : null;
                    const hasData = avg != null;
                    const weekday = new Date(year, month - 1, day).getDay();

                    const waitClass = hasData ? getWaitClass(avg) : '';
                    const disabledClass = hasData ? '' : 'disabled';
                    const label = hasData ? `${Math.round(avg)}åˆ†` : '-';

                    const cellHtml = `
                        <div class="calendar-day ${waitClass || ''} ${disabledClass}" ${hasData ? `onclick="jumpToDay('${dateStr}')"` : ''}>
                            <div class="calendar-day-header">
                                <span class="calendar-day-date">${day}</span>
                                <span class="calendar-day-weekday">${weekdays[weekday]}</span>
                            </div>
                            <div class="calendar-day-value">${label}</div>
                        </div>
                    `;
                    cells.push(cellHtml);
                }

                calendarsHtml += `
                    <div class="year-calendar-month">
                        <h4 class="year-calendar-month-title">${year}å¹´${monthNames[month - 1]}</h4>
                        <div class="calendar-grid">
                            ${headerRow}
                            ${cells.join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="calendar-container">
                    <h3 class="calendar-title">ğŸ“… æ··é›‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ${year}å¹´ï¼‰</h3>
                    <div class="calendar-note">ãã®æ—¥ã®å¹³å‡å¾…ã¡æ™‚é–“ã§è‰²åˆ†ã‘ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ—¥åˆ¥è©³ç´°ã«ç§»å‹•ã—ã¾ã™ã€‚</div>
                    <div class="year-calendars-wrapper">
                        ${calendarsHtml}
                    </div>
                </div>
            `;
        }

        function renderAreaSections(rideCards, areas) {
            let html = '';
            
            Object.entries(areas).forEach(([key, area]) => {
                const areaRides = rideCards.filter(r => r.area === key);
                if (areaRides.length === 0) return;
                
                // ã‚¨ãƒªã‚¢çµ±è¨ˆ
                const ridesWithData = areaRides.filter(r => r.waits.length > 0);
                const avgWait = ridesWithData.length > 0
                    ? Math.round(ridesWithData.reduce((sum, r) => sum + r.avgWait, 0) / ridesWithData.length)
                    : 0;

                html += `
                    <div class="area-section area-${key}">
                        <div class="area-header">
                            <span class="area-header-icon">${area.icon}</span>
                            <div class="area-header-info">
                                <div class="area-header-name">${area.name}</div>
                                <div class="area-header-stats">
                                    ${ridesWithData.length}/${areaRides.length} ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ | å¹³å‡å¾…ã¡æ™‚é–“: ${avgWait}åˆ†
                                </div>
                            </div>
                        </div>
                        <div class="rides-grid">
                            ${areaRides.map(ride => renderRideCard(ride)).join('')}
                        </div>
                    </div>
                `;
            });

            return html || '<div class="no-rides">è©²å½“ã™ã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }

        function renderRideCard(ride) {
            const cardClass = ride.waits.length === 0 ? 'closed' : '';
            const avgClass = getWaitClass(ride.avgWait);
            const isFavorite = favoriteRideIds && favoriteRideIds.has(String(ride.id));
            
            return `
                <div class="ride-card ${cardClass}" data-ride-id="${ride.id}">
                    <div class="ride-card-header">
                        <span class="ride-card-name">${escapeHtml(ride.name)}</span>
                        <button class="ride-card-fav-btn ${isFavorite ? 'active' : ''}" data-ride-id="${ride.id}" title="${isFavorite ? 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å¤–ã™' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ '}">
                            â˜…
                        </button>
                    </div>
                    ${ride.waits.length > 0 ? `
                        <div class="ride-card-stats">
                            <div class="ride-card-stat">
                                <span class="ride-card-stat-label">å¹³å‡</span>
                                <span class="ride-card-stat-value ${avgClass}">${ride.avgWait}<span class="unit">åˆ†</span></span>
                            </div>
                            <div class="ride-card-stat">
                                <span class="ride-card-stat-label">æœ€å¤§</span>
                                <span class="ride-card-stat-value">${ride.maxWait}<span class="unit">åˆ†</span></span>
                            </div>
                            <div class="ride-card-stat">
                                <span class="ride-card-stat-label">æœ€å°</span>
                                <span class="ride-card-stat-value">${ride.minWait}<span class="unit">åˆ†</span></span>
                            </div>
                        </div>
                    ` : `
                        <div class="ride-card-no-data">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                    `}
                </div>
            `;
        }

        function showRideDetail(rideId) {
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸Šã«æˆ»ã™
            window.scrollTo(0, 0);
            
            const content = document.getElementById('content');
            currentDetailRideId = rideId;
            
            const collected = collectRideData(rideId);
            const rideName = collected.rideName;
            const rideData = collected.data || [];

            const waits = rideData.filter(d => d.is_open && d.wait_time > 0).map(d => d.wait_time);
            const avgWait = waits.length > 0 ? Math.round(waits.reduce((a, b) => a + b, 0) / waits.length) : 0;
            const maxWait = waits.length > 0 ? Math.max(...waits) : 0;
            const minWait = waits.length > 0 ? Math.min(...waits) : 0;

            // æœŸé–“ã«å¿œã˜ãŸãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®HTML
            const heatmapHtml = currentPeriod === 'day' ? renderSingleRideHeatmap(rideId, rideName, rideData) : '';
            const dayTimeMatrixHtml = renderSingleRideDayTimeMatrix(rideId, rideName, rideData);
            const weekCalendarHtml = currentPeriod === 'week' ? renderSingleRideWeeklyCalendar(rideId, rideData) : '';
            const monthCalendarHtml = currentPeriod === 'month' ? renderSingleRideMonthlyCalendar(rideId, rideData) : '';
            const yearCalendarHtml = currentPeriod === 'year' ? renderSingleRideYearlyCalendar(rideId, rideData) : '';

            content.innerHTML = `
                <button class="back-to-list-btn" onclick="backToList()">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
                <div class="data-info">
                    <h3>ğŸ“Š ${rideName}</h3>
                    <div class="data-info-grid">
                        <div class="data-info-item">
                            <div class="data-info-value">${avgWait}åˆ†</div>
                            <div class="data-info-label">å¹³å‡å¾…ã¡æ™‚é–“</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value">${minWait}åˆ†</div>
                            <div class="data-info-label">æœ€çŸ­</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value">${maxWait}åˆ†</div>
                            <div class="data-info-label">æœ€é•·</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value">${rideData.length}</div>
                            <div class="data-info-label">è¨˜éŒ²æ•°</div>
                        </div>
                    </div>
                </div>
                <div class="compare-toolbar">
                    <div class="compare-toolbar-header">
                        <div class="compare-toolbar-title">ğŸ“Œ æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰</div>
                        <div style="font-size: 0.75rem; color: #a0a0a0;">ä»–ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®å¹³å‡ã‚’é‡ã­ã¦è¡¨ç¤ºã§ãã¾ã™</div>
                    </div>
                    <div>
                        <select id="compareSelect" class="compare-select">
                            <option value="">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦è¿½åŠ ...</option>
                        </select>
                        <div class="compare-chips" id="compareChips"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">å¾…ã¡æ™‚é–“æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                    <canvas id="waitTimeChart"></canvas>
                </div>
                ${weekCalendarHtml}
                ${monthCalendarHtml}
                ${yearCalendarHtml}
                ${heatmapHtml}
                ${dayTimeMatrixHtml}
                <div class="chart-container">
                    <h2 class="chart-title">è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
                    <div class="table-container">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>æ™‚åˆ»</th>
                                    <th>çŠ¶æ…‹</th>
                                    <th>å¾…ã¡æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            `;

            setupCompareControls(rideId, rideName, rideData);
            renderChart(rideName, rideData, rideId);
            renderTable(rideData);
        }

        function collectRideData(rideId) {
            const rideData = [];
            let rideName = '';

            if (!loadedData || !loadedData.records) {
                return { rideName: '', data: [] };
            }

            for (const record of loadedData.records) {
                const ride = record.rides.find(r => r.id === rideId);
                if (ride) {
                    rideName = getRideName(ride.id, ride.name);
                    rideData.push({
                        date: record.date,
                        time: record.time,
                        datetime: `${record.date} ${record.time}`,
                        is_open: ride.is_open,
                        wait_time: ride.wait_time
                    });
                }
            }

            return { rideName, data: rideData };
        }

        function setupCompareControls(primaryRideId, primaryRideName, primaryRideData) {
            const select = document.getElementById('compareSelect');
            const chipsContainer = document.getElementById('compareChips');
            const rideSelect = document.getElementById('rideSelect');
            if (!select || !chipsContainer || !rideSelect) return;

            // æ¯”è¼ƒå¯¾è±¡å€™è£œã‚’ã‚»ãƒ¬ã‚¯ãƒˆã«ã‚»ãƒƒãƒˆï¼ˆç¾åœ¨ã®ãƒ—ãƒ©ã‚¤ãƒãƒªã¨æ—¢ã«è¿½åŠ æ¸ˆã¿ã¯é™¤å¤–ï¼‰
            select.innerHTML = '<option value="">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦è¿½åŠ ...</option>';
            Array.from(rideSelect.options).forEach(opt => {
                if (opt.value === 'all') return;
                if (String(opt.value) === String(primaryRideId)) return;
                if (compareRideIds.has(String(opt.value))) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.textContent;
                select.appendChild(option);
            });

            // ç¾åœ¨ã®æ¯”è¼ƒå¯¾è±¡ãƒãƒƒãƒ—ã‚’æç”»ï¼ˆå­˜åœ¨ã—ãªã„IDã¯é™¤å¤–ï¼‰
            const validCompareIds = [];
            const labelMap = new Map();
            Array.from(rideSelect.options).forEach(opt => {
                if (opt.value !== 'all') {
                    labelMap.set(String(opt.value), opt.textContent);
                }
            });
            compareRideIds.forEach(id => {
                if (labelMap.has(id) && id !== String(primaryRideId)) {
                    validCompareIds.push(id);
                }
            });
            // ä¸æ­£ãªIDã¯ã‚»ãƒƒãƒˆã‹ã‚‰å–ã‚Šé™¤ã
            compareRideIds = new Set(validCompareIds);

            chipsContainer.innerHTML = validCompareIds.map(id => `
                <div class="compare-chip" data-ride-id="${id}">
                    <span>${escapeHtml(labelMap.get(id) || id)}</span>
                    <button type="button" data-remove-id="${id}">Ã—</button>
                </div>
            `).join('');

            // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã§æ¯”è¼ƒå¯¾è±¡è¿½åŠ 
            select.onchange = () => {
                const value = select.value;
                if (!value) return;
                compareRideIds.add(String(value));
                select.value = '';
                setupCompareControls(primaryRideId, primaryRideName, primaryRideData);
                renderChart(primaryRideName, primaryRideData, primaryRideId);
            };

            // ãƒãƒƒãƒ—ã®Ã—ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
            chipsContainer.querySelectorAll('button[data-remove-id]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-remove-id');
                    if (!id) return;
                    compareRideIds.delete(String(id));
                    setupCompareControls(primaryRideId, primaryRideName, primaryRideData);
                    renderChart(primaryRideName, primaryRideData, primaryRideId);
                });
            });
        }

        function renderChart(rideName, rideData, primaryRideId) {
            const ctx = document.getElementById('waitTimeChart');
            if (!ctx) return;

            if (chart) {
                chart.destroy();
            }

            let labels = [];
            let xAxisTitle = '';

            // ãƒ©ãƒ™ãƒ«ã¨ã€ä¸ãˆã‚‰ã‚ŒãŸ rideData ã‹ã‚‰é›†è¨ˆé…åˆ—ã‚’ä½œã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’æœŸé–“ã”ã¨ã«ç”¨æ„
            let buildSeries;

            if (currentPeriod === 'day') {
                // æ—¥å˜ä½: 9:00ã€œ21:00 ã‚’30åˆ†åˆ»ã¿ã§è¡¨ç¤º
                for (let h = 9; h <= 21; h++) {
                    labels.push(`${h.toString().padStart(2, '0')}:00`);
                    if (h !== 21) {
                        labels.push(`${h.toString().padStart(2, '0')}:30`);
                    }
                }
                xAxisTitle = 'æ™‚åˆ»';
                buildSeries = (series) => {
                    const data = new Array(labels.length).fill(null);
                    for (const d of series) {
                        if (d.is_open && d.wait_time !== null) {
                            const [hours, minutes] = d.time.split(':').map(Number);
                            if (hours < 9 || hours > 21) continue;
                            const baseIndex = (hours - 9) * 2;
                            const index30 = minutes >= 30 ? baseIndex + 1 : baseIndex;
                            if (index30 >= 0 && index30 < data.length) {
                                data[index30] = d.wait_time;
                            }
                        }
                    }
                    return data;
                };
            } else if (currentPeriod === 'week') {
                // é€±å˜ä½: é¸æŠã—ãŸé€±ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šï¼‰ã®7æ—¥åˆ†ã‚’ X è»¸ã«è¡¨ç¤ºï¼ˆä¾‹: 2/5(æœ¨)ï¼‰
                const weekStartStr = loadedData?.selectedValue;
                const weekDates = [];
                if (weekStartStr) {
                    const weekStart = parseDateStringToLocalDate(weekStartStr);
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(weekStart);
                        d.setDate(weekStart.getDate() + i);
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        weekDates.push(`${y}-${m}-${day}`);
                    }
                }
                labels = weekDates.map(d => formatWeekDateLabel(d));
                xAxisTitle = 'æ—¥ä»˜';
                buildSeries = (series) => {
                    const buckets = weekDates.map(() => []);
                    for (const d of series) {
                        if (d.is_open && d.wait_time !== null && d.date) {
                            const pos = weekDates.indexOf(d.date);
                            if (pos !== -1) {
                                buckets[pos].push(d.wait_time);
                            }
                        }
                    }
                    return buckets.map(waits =>
                        waits.length > 0 ? Math.round(waits.reduce((a, b) => a + b, 0) / waits.length) : null
                    );
                };
            } else if (currentPeriod === 'month') {
                // æœˆå˜ä½: æ—¥ã”ã¨ã®å¹³å‡ï¼ˆãã®æœˆã®å…¨æ—¥ä»˜ã‚’è¡¨ç¤ºï¼‰
                const selectedMonth = loadedData.selectedValue || '';
                const [year, month] = selectedMonth.split('-');
                const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                labels = Array.from({ length: daysInMonth }, (_, i) => `${i + 1}æ—¥`);
                xAxisTitle = 'æ—¥';
                buildSeries = (series) => {
                    const buckets = Array(daysInMonth).fill(null).map(() => []);
                    for (const d of series) {
                        if (d.is_open && d.wait_time !== null && d.date) {
                            const dayNum = parseInt(d.date.split('-')[2], 10);
                            if (dayNum >= 1 && dayNum <= daysInMonth) {
                                buckets[dayNum - 1].push(d.wait_time);
                            }
                        }
                    }
                    return buckets.map(waits =>
                        waits.length > 0 ? Math.round(waits.reduce((a, b) => a + b, 0) / waits.length) : null
                    );
                };
            } else if (currentPeriod === 'year') {
                // å¹´å˜ä½: æœˆã”ã¨ã®å¹³å‡
                labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                xAxisTitle = 'æœˆ';
                buildSeries = (series) => {
                    const buckets = Array(12).fill(null).map(() => []);
                    for (const d of series) {
                        if (d.is_open && d.wait_time !== null && d.date) {
                            const monthNum = parseInt(d.date.split('-')[1], 10) - 1;
                            if (monthNum >= 0 && monthNum < 12) {
                                buckets[monthNum].push(d.wait_time);
                            }
                        }
                    }
                    return buckets.map(waits =>
                        waits.length > 0 ? Math.round(waits.reduce((a, b) => a + b, 0) / waits.length) : null
                    );
                };
            }

            const primarySeries = buildSeries ? buildSeries(rideData) : [];

            // Xè»¸ã®tickè¨­å®šã‚’æœŸé–“ã«å¿œã˜ã¦è¨­å®š
            const xTicksConfig2 = {
                color: '#a0a0a0',
                maxRotation: currentPeriod === 'month' ? 45 : 0,
                font: { size: 14, weight: 'bold' }
            };
            if (currentPeriod === 'day') {
                // 30åˆ†åˆ»ã¿ãƒ‡ãƒ¼ã‚¿ã ãŒã€ãƒ©ãƒ™ãƒ«ã¯1æ™‚é–“ã”ã¨ã«è¡¨ç¤º
                xTicksConfig2.callback = function(val, index) { 
                    return index % 2 === 0 ? this.getLabelForValue(val) : ''; 
                };
            } else if (currentPeriod === 'month' && labels.length > 15) {
                xTicksConfig2.callback = function(val, index) { 
                    return index % 5 === 0 ? this.getLabelForValue(val) : ''; 
                };
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‹æ¯”è¼ƒå¯¾è±¡ï¼‰ã‚’æ§‹ç¯‰
            const datasets = [{
                label: rideName,
                data: primarySeries,
                borderColor: '#4ecdc4',
                backgroundColor: 'rgba(78, 205, 196, 0.2)',
                fill: true,
                tension: 0.4,
                spanGaps: true,
                pointRadius: 6,
                pointHoverRadius: 10,
                borderWidth: 4
            }];

            // æ¯”è¼ƒå¯¾è±¡ç”¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
            const compareColors = [
                '#ff6b6b',
                '#f9ca24',
                '#45b7d1',
                '#e84393',
                '#00b894',
                '#fdcb6e',
                '#6c5ce7',
                '#fd79a8'
            ];

            if (buildSeries && compareRideIds.size > 0 && loadedData && loadedData.records) {
                const compareIds = Array.from(compareRideIds);
                compareIds.forEach((id, idx) => {
                    const { rideName: cmpName, data: cmpRaw } = collectRideData(parseInt(id, 10));
                    if (!cmpRaw || !cmpRaw.length) return;
                    const cmpSeries = buildSeries(cmpRaw);
                    datasets.push({
                        label: cmpName || `ID ${id}`,
                        data: cmpSeries,
                        borderColor: compareColors[idx % compareColors.length],
                        backgroundColor: 'transparent',
                        fill: false,
                        tension: 0.4,
                        spanGaps: true,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        borderWidth: 3
                    });
                });
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: rideName,
                            color: '#fff',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: xTicksConfig2,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: xAxisTitle,
                                color: '#a0a0a0',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a0a0a0', font: { size: 14, weight: 'bold' } },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: 'å¾…ã¡æ™‚é–“ï¼ˆåˆ†ï¼‰',
                                color: '#a0a0a0',
                                font: { size: 16, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function renderTable(rideData) {
            const tbody = document.querySelector('#dataTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const reversedData = [...rideData].reverse();

            for (const d of reversedData) {
                const waitClass = getWaitClass(d.wait_time);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.time}</td>
                    <td>${d.is_open ? 'ğŸŸ¢ é‹å–¶ä¸­' : 'âš« ä¼‘æ­¢ä¸­'}</td>
                    <td class="${waitClass}">${d.is_open ? d.wait_time + 'åˆ†' : '-'}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function getWaitClass(waitTime) {
            // park-data.js ã§å®šç¾©ã—ãŸå…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨
            return getWaitClassGlobal(waitTime);
        }

        function backToList() {
            currentDetailRideId = null;
            document.getElementById('rideSelect').value = 'all';
            showAllRides();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // â”€â”€ å‰å›ã®æ¥åœ’æ—¥ã¨æ¯”è¼ƒ â”€â”€
        function getCurrentViewingDate() {
            if (!loadedData) return null;
            if (loadedData.dateRange && loadedData.dateRange.length > 0) return loadedData.dateRange[0];
            if (loadedData.selectedValue) return loadedData.selectedValue;
            if (loadedData.date) return loadedData.date;
            return null;
        }

        function getDaysInMonth(year, month) {
            return new Date(parseInt(year, 10), parseInt(month, 10), 0).getDate();
        }

        function updateCompareDayOptions() {
            const yearSelect = document.getElementById('compareYear');
            const monthSelect = document.getElementById('compareMonth');
            const daySelect = document.getElementById('compareDay');
            if (!yearSelect || !monthSelect || !daySelect) return;
            const year = yearSelect.value;
            const month = monthSelect.value;
            if (!year || !month) return;
            const lastDay = getDaysInMonth(year, month);
            const currentDay = parseInt(daySelect.value, 10) || 1;
            daySelect.innerHTML = '';
            for (let d = 1; d <= lastDay; d++) {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d + 'æ—¥';
                if (d === Math.min(currentDay, lastDay)) opt.selected = true;
                daySelect.appendChild(opt);
            }
        }

        function getJstDate() {
            const now = new Date();
            const ymd = now.toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' });
            const [y, m, d] = ymd.split('-');
            return { year: parseInt(y, 10), month: m, day: d };
        }

        function renderCompareSection() {
            const baseDate = getCurrentViewingDate();
            if (!baseDate) return '';
            const jst = getJstDate();
            const currentYear = jst.year;
            const currentMonth = jst.month;
            const currentDay = jst.day;
            const yearOptions = [];
            for (let y = currentYear; y >= currentYear - 3; y--) {
                yearOptions.push(`<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`);
            }
            const monthOptions = Array.from({ length: 12 }, (_, i) => {
                const v = String(i + 1).padStart(2, '0');
                return `<option value="${v}" ${v === currentMonth ? 'selected' : ''}>${i + 1}æœˆ</option>`;
            }).join('');
            const dayOptions = Array.from({ length: 31 }, (_, i) => {
                const v = String(i + 1).padStart(2, '0');
                return `<option value="${v}" ${v === currentDay ? 'selected' : ''}>${i + 1}æ—¥</option>`;
            }).join('');
            return `
                <div class="compare-section">
                    <div class="compare-section-title">ğŸ“… å‰å›ã®æ¥åœ’æ—¥ã¨æ¯”è¼ƒ</div>
                    <div class="compare-controls">
                        <label>å‰å›è¡Œã£ãŸæ—¥ï¼š</label>
                        <select id="compareYear">${yearOptions}</select>
                        <select id="compareMonth">${monthOptions}</select>
                        <select id="compareDay">${dayOptions}</select>
                        <button type="button" class="compare-btn" id="compareBtn">æ¯”è¼ƒã™ã‚‹</button>
                    </div>
                    <p class="compare-note">éå»365æ—¥ä»¥å¤–ã®æ—¥ä»˜ã¯ã€ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—ã—ã¦æ¯”è¼ƒã—ã¾ã™ã€‚</p>
                    <div id="compareResult"></div>
                </div>
            `;
        }

        async function fetchHistoryDataForDate(dateStr) {
            if (!dateStr || !currentPark) return null;
            if (USE_SUPABASE) return await fetchSupabaseDataForDate(currentPark, dateStr);
            return null;
        }

        function computeDayStats(records) {
            const rideWaits = new Map();
            let parkSum = 0;
            let parkCount = 0;
            for (const record of records) {
                for (const ride of record.rides) {
                    if (ride.is_open && ride.wait_time > 0) {
                        const key = String(ride.id);
                        if (!rideWaits.has(key)) rideWaits.set(key, []);
                        rideWaits.get(key).push(ride.wait_time);
                        parkSum += ride.wait_time;
                        parkCount++;
                    }
                }
            }
            const rideAvg = new Map();
            rideWaits.forEach((waits, id) => {
                const avg = waits.reduce((a, b) => a + b, 0) / waits.length;
                rideAvg.set(id, Math.round(avg * 10) / 10);
            });
            const parkAvg = parkCount > 0 ? Math.round((parkSum / parkCount) * 10) / 10 : 0;
            return { rideAvg, parkAvg };
        }

        function getCompareDateFromInputs() {
            const y = document.getElementById('compareYear');
            const m = document.getElementById('compareMonth');
            const d = document.getElementById('compareDay');
            if (!y || !m || !d || !y.value || !m.value || !d.value) return null;
            return `${y.value}-${String(m.value).padStart(2, '0')}-${String(d.value).padStart(2, '0')}`;
        }

        async function runCompare() {
            const resultEl = document.getElementById('compareResult');
            const btnEl = document.getElementById('compareBtn');
            if (!resultEl || !loadedData) return;
            const compareDate = getCompareDateFromInputs();
            if (!compareDate) {
                resultEl.innerHTML = '<div class="compare-no-data">å¹´ãƒ»æœˆãƒ»æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }
            const baseDate = getCurrentViewingDate();
            if (baseDate === compareDate) {
                resultEl.innerHTML = '<div class="compare-no-data">åŸºæº–æ—¥ã¨åˆ¥ã®æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }
            const today = new Date();
            const jstToday = new Date(today.getTime() + (9 * 60 * 60 * 1000));
            const todayStr = jstToday.toISOString().split('T')[0];
            if (compareDate > todayStr) {
                resultEl.innerHTML = '<div class="compare-no-data">å‰å›ã®æ¥åœ’æ—¥ã¯ä»Šæ—¥ä»¥å‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }
            if (btnEl) {
                btnEl.disabled = true;
                btnEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
            }
            resultEl.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p></div>';
            try {
                const compareData = await fetchHistoryDataForDate(compareDate);
                if (!compareData || !compareData.records.length) {
                    resultEl.innerHTML = '<div class="compare-no-data">å‰å›ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
                    return;
                }
                const baseStats = computeDayStats(loadedData.records);
                const compareStats = computeDayStats(compareData.records);
                const baseParkAvg = baseStats.parkAvg;
                const compareParkAvg = compareStats.parkAvg;
                const parkDiff = baseParkAvg - compareParkAvg;
                let summaryClass = 'same';
                let summaryText = '';
                if (Math.abs(parkDiff) < 1) {
                    summaryText = `å‰å›ï¼ˆ${formatDateForPeriod(compareDate, 'day')}ï¼‰ã¨ã»ã¼åŒã˜æ··é›‘åº¦ã§ã™ã€‚`;
                } else if (parkDiff < 0) {
                    summaryClass = 'more';
                    summaryText = `å‰å›ï¼ˆ${formatDateForPeriod(compareDate, 'day')}ï¼‰ã‚ˆã‚Š å¹³å‡ ${Math.abs(parkDiff).toFixed(1)}åˆ† æ··ã‚“ã§ã„ã¾ã™ã€‚`;
                } else {
                    summaryClass = 'less';
                    summaryText = `å‰å›ï¼ˆ${formatDateForPeriod(compareDate, 'day')}ï¼‰ã‚ˆã‚Š å¹³å‡ ${parkDiff.toFixed(1)}åˆ† ç©ºã„ã¦ã„ã¾ã™ã€‚`;
                }
                const allRideIds = new Set([...baseStats.rideAvg.keys(), ...compareStats.rideAvg.keys()]);
                const rowData = [];
                for (const rideId of allRideIds) {
                    const name = getRideName(parseInt(rideId, 10), '');
                    const baseAvg = baseStats.rideAvg.get(rideId);
                    const compareAvg = compareStats.rideAvg.get(rideId);
                    if (baseAvg == null && compareAvg == null) continue;
                    const baseStr = baseAvg != null ? baseAvg + 'åˆ†' : '-';
                    const compareStr = compareAvg != null ? compareAvg + 'åˆ†' : '-';
                    let diffHtml = '-';
                    let diffClass = 'compare-diff-same';
                    if (baseAvg != null && compareAvg != null) {
                        const diff = baseAvg - compareAvg;
                        if (Math.abs(diff) < 1) {
                            diffHtml = 'Â±0åˆ†';
                        } else if (diff > 0) {
                            diffClass = 'compare-diff-more';
                            diffHtml = '+' + diff.toFixed(1) + 'åˆ†';
                        } else {
                            diffClass = 'compare-diff-less';
                            diffHtml = diff.toFixed(1) + 'åˆ†';
                        }
                    }
                    rowData.push({ name, baseStr, compareStr, diffHtml, diffClass });
                }
                rowData.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                const rows = rowData.map(r => `<tr><td>${escapeHtml(r.name)}</td><td>${r.baseStr}</td><td>${r.compareStr}</td><td class="${r.diffClass}">${r.diffHtml}</td></tr>`);
                resultEl.innerHTML = `
                    <div class="compare-summary ${summaryClass}">${summaryText}<br><span style="font-size:0.9rem;opacity:0.9;">ä»Šå› ${baseParkAvg}åˆ† vs å‰å› ${compareParkAvg}åˆ†ï¼ˆãƒ‘ãƒ¼ã‚¯å¹³å‡ï¼‰</span></div>
                    <div class="compare-table-wrapper">
                        <table class="compare-table">
                            <thead><tr><th>ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</th><th>ä»Šå›ï¼ˆ${formatDateForPeriod(baseDate, 'day')}ï¼‰</th><th>å‰å›ï¼ˆ${formatDateForPeriod(compareDate, 'day')}ï¼‰</th><th>å·®</th></tr></thead>
                            <tbody>${rows.join('')}</tbody>
                        </table>
                    </div>
                `;
            } catch (e) {
                resultEl.innerHTML = '<div class="compare-no-data">æ¯”è¼ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>';
            } finally {
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.textContent = 'æ¯”è¼ƒã™ã‚‹';
                }
            }
        }

        // ã‚°ãƒ©ãƒ•ã®ç‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
        function showPointPopup(candidates, event) {
            // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
            const existing = document.getElementById('pointPopupOverlay');
            if (existing) {
                existing.remove();
            }

            const overlay = document.createElement('div');
            overlay.id = 'pointPopupOverlay';
            overlay.className = 'point-popup-overlay';

            const popup = document.createElement('div');
            popup.className = 'point-popup';

            const header = document.createElement('div');
            header.className = 'point-popup-header';
            const title = document.createElement('div');
            title.className = 'point-popup-title';
            title.textContent = 'ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'point-popup-close';
            closeBtn.type = 'button';
            closeBtn.textContent = 'Ã—';
            closeBtn.addEventListener('click', () => overlay.remove());

            header.appendChild(title);
            header.appendChild(closeBtn);

            const list = document.createElement('div');
            list.className = 'point-popup-list';

            candidates.forEach(c => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'point-popup-item';

                const main = document.createElement('div');
                main.className = 'point-popup-item-main';
                const name = document.createElement('span');
                name.className = 'point-popup-item-name';
                name.textContent = c.name;
                const wait = document.createElement('span');
                wait.textContent = `${c.wait}åˆ†`;

                const meta = document.createElement('div');
                meta.className = 'point-popup-item-meta';
                meta.textContent = c.timeLabel;

                main.appendChild(name);
                main.appendChild(wait);
                item.appendChild(main);
                item.appendChild(meta);

                item.addEventListener('click', () => {
                    const rideSelect = document.getElementById('rideSelect');
                    if (rideSelect) {
                        rideSelect.value = String(c.rideId);
                    }
                    showRideDetail(c.rideId);
                    overlay.remove();
                });

                list.appendChild(item);
            });

            popup.appendChild(header);
            popup.appendChild(list);
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åãŒ1è¡Œã«åã¾ã‚‹ã‚ˆã†ã€ãƒªã‚¹ãƒˆå†…ã§æœ€ã‚‚å¹…ã®åºƒã„è¦ç´ ã«åˆã‚ã›ã¦æ¨ªå¹…ã‚’èª¿æ•´
            let maxItemWidth = 0;
            const mains = list.querySelectorAll('.point-popup-item-main');
            mains.forEach(el => {
                const w = el.scrollWidth;
                if (w > maxItemWidth) maxItemWidth = w;
            });
            // åå‰ï¼‹å¾…ã¡æ™‚é–“ã®è¡Œã«ååˆ†ãªä½™ç™½ã‚’æŒãŸã›ã¤ã¤ã€ç”»é¢å¹…ã«åã¾ã‚‹ã‚ˆã†ã«ã™ã‚‹
            const horizontalPadding = 80; // å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼‹ä½™è£•ã‚’å°‘ã—å¤§ãã‚ã«
            const targetWidth = Math.min(maxItemWidth + horizontalPadding, window.innerWidth - 24);
            if (targetWidth > 0) {
                popup.style.width = `${targetWidth}px`;
            }

            // é«˜ã•ã‚’å…¨å€™è£œãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã§ã¡ã‚‡ã†ã©åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´
            // ã¾ãšè‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã•ã›ã¦ã‹ã‚‰ã€å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é«˜ã•(scrollHeight)ã‚’æ¡ç”¨ã™ã‚‹
            popup.style.height = 'auto';
            list.style.maxHeight = 'none';
            const headerRect = header.getBoundingClientRect();
            const listContentHeight = list.scrollHeight; // ãƒœã‚¿ãƒ³åŒå£«ã®ä½™ç™½ã‚‚å«ã‚ãŸå®Ÿé«˜ã•
            const verticalPadding = 40; // ä¸Šä¸‹ã®ä½™è£•åˆ†ï¼ˆå°‘ã—å¤šã‚ã«ã—ã¦ä½™ç™½ã‚’ç¢ºä¿ï¼‰
            const popupHeight = headerRect.height + listContentHeight + verticalPadding;
            popup.style.height = `${popupHeight}px`;

            // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ãŒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­å¤®ä»˜è¿‘ã«ãªã‚‹ã‚ˆã†é…ç½®ï¼ˆç”»é¢å¤–ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†èª¿æ•´ï¼‰
            const clickX = event.clientX ?? 0;
            const clickY = event.clientY ?? 0;
            const rect = popup.getBoundingClientRect();

            let left = clickX - rect.width / 2;
            let top = clickY - rect.height / 2;

            const vw = window.innerWidth;

            if (left + rect.width > vw - 8) {
                left = vw - rect.width - 8;
            }

            if (left < 8) left = 8;
            if (top < 8) top = 8;

            popup.style.left = `${left}px`;
            popup.style.top = `${top}px`;

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–ï¼‰
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // æœŸé–“ã‚¿ãƒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.addEventListener('click', async () => {
                document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentPeriod = tab.dataset.period;
                selectedAreas = [];
                // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å€‹åˆ¥ç”»é¢ã§ãªã„å ´åˆã®ã¿ãƒªã‚»ãƒƒãƒˆ
                if (currentDetailRideId === null) {
                    document.getElementById('rideSelect').value = 'all';
                }
                await updateDateSelectOptions();
            });
        });

        // æ—¥ä»˜é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('dateSelect').addEventListener('change', async (e) => {
            if (e.target.value) {
                // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å€‹åˆ¥ç”»é¢ã§ãªã„å ´åˆã®ã¿ãƒªã‚»ãƒƒãƒˆ
                if (currentDetailRideId === null) {
                    document.getElementById('rideSelect').value = 'all';
                }
                selectedAreas = []; // ã‚¨ãƒªã‚¢é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã™ã¹ã¦é¸æŠï¼‰
                await loadPeriodData(e.target.value);
            }
        });

        document.getElementById('rideSelect').addEventListener('change', (e) => {
            if (e.target.value === 'all') {
                currentDetailRideId = null;
                showAllRides();
            } else {
                const rideId = parseInt(e.target.value);
                if (rideId && loadedData) {
                    showRideDetail(rideId);
                }
            }
        });

        async function jumpToDay(dateStr) {
            // ã€Œæ—¥ã€ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            const dayTab = document.querySelector('.period-tab[data-period="day"]');
            if (dayTab) {
                dayTab.classList.add('active');
            }

            currentPeriod = 'day';
            selectedAreas = [];
            const rideSelect = document.getElementById('rideSelect');
            if (rideSelect) {
                rideSelect.value = 'all';
            }

            const dateSelect = document.getElementById('dateSelect');

            // æ—¥ä»˜ã‚»ãƒ¬ã‚¯ãƒˆã«ç›®çš„ã®æ—¥ä»˜ãŒãªã‘ã‚Œã°ã€æ—¥ãƒ“ãƒ¥ãƒ¼ç”¨ã«å†æ§‹ç¯‰
            if (!Array.from(dateSelect.options).some(opt => opt.value === dateStr)) {
                await updateDateSelectOptions();
            }

            dateSelect.value = dateStr;
            await loadPeriodData(dateStr);
        }

        // æœŸé–“ã«å¿œã˜ãŸæ—¥ä»˜é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        async function updateDateSelectOptions() {
            const dateSelect = document.getElementById('dateSelect');
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;

            if (currentPeriod === 'day') {
                // æ—¥å˜ä½: åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ãƒªã‚¹ãƒˆ
                dateSelect.innerHTML = '<option value="">æ—¥ä»˜ã‚’é¸æŠ...</option>';
                for (const date of availableDates) {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = formatDateForPeriod(date, 'day');
                    dateSelect.appendChild(option);
                }
                if (availableDates.length > 0) {
                    dateSelect.value = availableDates[0];
                    await loadPeriodData(availableDates[0]);
                }
            } else if (currentPeriod === 'week') {
                // é€±å˜ä½: é€±ã®é–‹å§‹æ—¥ãƒªã‚¹ãƒˆ
                const weeks = getWeekOptions();
                dateSelect.innerHTML = '<option value="">é€±ã‚’é¸æŠ...</option>';
                for (const week of weeks) {
                    const option = document.createElement('option');
                    option.value = week.start;
                    option.textContent = week.label;
                    dateSelect.appendChild(option);
                }
                if (weeks.length > 0) {
                    dateSelect.value = weeks[0].start;
                    await loadPeriodData(weeks[0].start);
                }
            } else if (currentPeriod === 'month') {
                // æœˆå˜ä½
                const months = getMonthOptions();
                dateSelect.innerHTML = '<option value="">æœˆã‚’é¸æŠ...</option>';
                for (const month of months) {
                    const option = document.createElement('option');
                    option.value = month.value;
                    option.textContent = month.label;
                    dateSelect.appendChild(option);
                }
                if (months.length > 0) {
                    dateSelect.value = months[0].value;
                    await loadPeriodData(months[0].value);
                }
            } else if (currentPeriod === 'year') {
                // å¹´å˜ä½
                const years = getYearOptions();
                dateSelect.innerHTML = '<option value="">å¹´ã‚’é¸æŠ...</option>';
                for (const year of years) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `${year}å¹´`;
                    dateSelect.appendChild(option);
                }
                if (years.length > 0) {
                    dateSelect.value = years[0];
                    await loadPeriodData(years[0]);
                }
            }
        }

        function formatDateForPeriod(dateStr, period) {
            const date = new Date(dateStr);
            if (period === 'day') {
                return date.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' });
            }
            return dateStr;
        }

        function formatWeekDateLabel(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = 'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[date.getDay()];
            return `${month}/${day}(${weekday})`;
        }

        function parseDateStringToLocalDate(dateStr) {
            // "YYYY-MM-DD" ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã® Date ã«å®‰å…¨ã«å¤‰æ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãšã‚Œé˜²æ­¢ï¼‰
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function computeVisitSummary() {
            if (!loadedData || !loadedData.records || loadedData.records.length === 0) return null;

            const records = loadedData.records;
            const weekdayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            if (currentPeriod === 'week' || currentPeriod === 'month') {
                // æ›œæ—¥ã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“ï¼ˆå…¨ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ»å…¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
                const stats = Array(7).fill(null).map(() => ({ sum: 0, count: 0 }));

                for (const rec of records) {
                    const date = new Date(rec.date);
                    const dow = date.getDay(); // 0=æ—¥
                    for (const ride of rec.rides) {
                        if (ride.is_open && ride.wait_time > 0) {
                            stats[dow].sum += ride.wait_time;
                            stats[dow].count += 1;
                        }
                    }
                }

                const averages = stats
                    .map((s, idx) => (s.count > 0 ? { key: idx, label: `${weekdayLabels[idx]}æ›œæ—¥`, avg: s.sum / s.count } : null))
                    .filter(Boolean)
                    .sort((a, b) => a.avg - b.avg)
                    .slice(0, 3);

                if (!averages.length) return null;

                return {
                    title: currentPeriod === 'week' ? 'ã“ã®é€±ã®ãŠã™ã™ã‚æ›œæ—¥ï¼ˆçŸ­ã„é †ï¼‰' : 'ã“ã®æœˆã®ãŠã™ã™ã‚æ›œæ—¥ï¼ˆçŸ­ã„é †ï¼‰',
                    items: averages.map((a, i) => ({
                        rank: i + 1,
                        label: a.label,
                        avgMinutes: Math.round(a.avg)
                    }))
                };
            }

            if (currentPeriod === 'year') {
                // æœˆã”ã¨ã®å¹³å‡å¾…ã¡æ™‚é–“
                const monthStats = Array(12).fill(null).map(() => ({ sum: 0, count: 0 }));

                for (const rec of records) {
                    if (!rec.date) continue;
                    const [y, m] = rec.date.split('-');
                    const monthIdx = parseInt(m, 10) - 1;
                    if (monthIdx < 0 || monthIdx > 11) continue;

                    for (const ride of rec.rides) {
                        if (ride.is_open && ride.wait_time > 0) {
                            monthStats[monthIdx].sum += ride.wait_time;
                            monthStats[monthIdx].count += 1;
                        }
                    }
                }

                const averages = monthStats
                    .map((s, idx) => (s.count > 0 ? { key: idx, label: `${idx + 1}æœˆ`, avg: s.sum / s.count } : null))
                    .filter(Boolean)
                    .sort((a, b) => a.avg - b.avg)
                    .slice(0, 3);

                if (!averages.length) return null;

                return {
                    title: 'ã“ã®å¹´ã®ãŠã™ã™ã‚æœˆï¼ˆçŸ­ã„é †ï¼‰',
                    items: averages.map((a, i) => ({
                        rank: i + 1,
                        label: a.label,
                        avgMinutes: Math.round(a.avg)
                    }))
                };
            }

            return null;
        }

        function loadFavoriteRides() {
            try {
                const raw = localStorage.getItem('tdr_wait_favorites');
                if (!raw) return;
                const arr = JSON.parse(raw);
                if (Array.isArray(arr)) {
                    favoriteRideIds = new Set(arr.map(id => String(id)));
                }
            } catch (e) {
                console.warn('Failed to load favorites', e);
            }
        }

        function saveFavoriteRides() {
            try {
                const arr = Array.from(favoriteRideIds);
                localStorage.setItem('tdr_wait_favorites', JSON.stringify(arr));
            } catch (e) {
                console.warn('Failed to save favorites', e);
            }
        }

        function toggleFavoriteRide(rideId) {
            const key = String(rideId);
            if (favoriteRideIds.has(key)) {
                favoriteRideIds.delete(key);
            } else {
                favoriteRideIds.add(key);
            }
            saveFavoriteRides();
        }

        function getWeekOptions() {
            const weeks = [];
            const seenWeeks = new Set();
            
            for (const dateStr of availableDates) {
                const date = new Date(dateStr);
                const dayOfWeek = date.getDay(); // æ—¥æ›œ=0
                const sunday = new Date(date);
                sunday.setDate(date.getDate() - dayOfWeek); // ãã®é€±ã®æ—¥æ›œæ—¥
                const weekStart = sunday.toISOString().split('T')[0];
                
                if (!seenWeeks.has(weekStart)) {
                    seenWeeks.add(weekStart);
                    const saturday = new Date(sunday);
                    saturday.setDate(sunday.getDate() + 6);
                    weeks.push({
                        start: weekStart,
                        label: `${sunday.getMonth() + 1}/${sunday.getDate()}(æ—¥) ã€œ ${saturday.getMonth() + 1}/${saturday.getDate()}(åœŸ)`
                    });
                }
            }
            return weeks;
        }

        function getMonthOptions() {
            const months = [];
            const seenMonths = new Set();
            
            for (const dateStr of availableDates) {
                const [year, month] = dateStr.split('-');
                const monthKey = `${year}-${month}`;
                
                if (!seenMonths.has(monthKey)) {
                    seenMonths.add(monthKey);
                    months.push({
                        value: monthKey,
                        label: `${year}å¹´${parseInt(month)}æœˆ`
                    });
                }
            }
            return months;
        }

        function getYearOptions() {
            const years = new Set();
            for (const dateStr of availableDates) {
                years.add(dateStr.split('-')[0]);
            }
            return [...years].sort().reverse();
        }

        // æœŸé–“ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadPeriodData(value) {
            const parkInfo = PARKS[currentPark];
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;

            try {
                let datesToLoad = [];
                
                if (currentPeriod === 'day') {
                    datesToLoad = [value];
                } else if (currentPeriod === 'week') {
                    // é€±ã®æ—¥æ›œæ—¥ã‹ã‚‰åœŸæ›œæ—¥ã¾ã§
                    const sunday = new Date(value);
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(sunday);
                        d.setDate(sunday.getDate() + i);
                        datesToLoad.push(d.toISOString().split('T')[0]);
                    }
                } else if (currentPeriod === 'month') {
                    // æœˆã®å…¨æ—¥
                    const [year, month] = value.split('-');
                    const firstDay = new Date(year, parseInt(month) - 1, 1);
                    const lastDay = new Date(year, parseInt(month), 0);
                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        datesToLoad.push(d.toISOString().split('T')[0]);
                    }
                } else if (currentPeriod === 'year') {
                    // å¹´ã®å…¨æ—¥ï¼ˆåˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã®ã¿ï¼‰
                    datesToLoad = availableDates.filter(d => d.startsWith(value));
                }

                // åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                datesToLoad = datesToLoad.filter(d => availableDates.includes(d));

                if (datesToLoad.length === 0) {
                    content.innerHTML = `
                        <div class="no-data">
                            <h2>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                            <p>é¸æŠã—ãŸæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                        </div>
                    `;
                    return;
                }

                // Supabase ã‹ã‚‰è¤‡æ•°æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§çµ±åˆ
                const allRecords = [];
                for (const date of datesToLoad) {
                    const data = await fetchSupabaseDataForDate(currentPark, date);
                    if (data && data.records) {
                        for (const record of data.records) {
                            allRecords.push({
                                date: record.date,
                                time: record.time,
                                timestamp: record.timestamp,
                                rides: record.rides
                            });
                        }
                    }
                }

                loadedData = {
                    park: parkInfo.name,
                    period: currentPeriod,
                    selectedValue: value,  // é¸æŠã•ã‚ŒãŸå€¤ï¼ˆæœˆã®å ´åˆã¯"YYYY-MM"ï¼‰
                    dateRange: datesToLoad,
                    records: allRecords
                };

                populateRideSelect();
                
                // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å€‹åˆ¥ç”»é¢ã‚’ç¶­æŒï¼ˆæœŸé–“/æ—¥ä»˜å¤‰æ›´æ™‚ï¼‰
                if (currentDetailRideId !== null) {
                    document.getElementById('rideSelect').value = currentDetailRideId;
                    showRideDetail(currentDetailRideId);
                } else {
                    showAllRides();
                }

                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§rideãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°è©³ç´°è¡¨ç¤ºï¼ˆåˆå›ã®ã¿ï¼‰
                if (!initialRideHandled && rideParam) {
                    initialRideHandled = true;
                    const rideId = parseInt(rideParam);
                    if (rideId) {
                        document.getElementById('rideSelect').value = rideId;
                        showRideDetail(rideId);
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `
                    <div class="error">
                        <h3>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
